/**
 * id: ao58
 * path: @bilibili-live/web-player-video
 */

(function(require,module,exports) {
"use strict";var e,t,r,i,n,o,a,s,u,d,f,c,l,h,p=this&&this.__assign||function(){return(p=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},v=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(n,o){function a(e){try{u(i.next(e))}catch(t){o(t)}}function s(e){try{u(i.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,s)}u((i=i.apply(e,t||[])).next())})},m=this&&this.__generator||function(e,t){var r,i,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(u){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(r=1,i&&(n=2&s[0]?i.return:s[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,s[1])).done)return n;switch(i=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){a.label=s[1];break}if(6===s[0]&&a.label<n[1]){a.label=n[1],n=s;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(s);break}n[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(u){s=[6,u],i=0}finally{r=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}},y=this&&this.__classPrivateFieldGet||function(e,t,r,i){if("a"===r&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)},w=this&&this.__classPrivateFieldSet||function(e,t,r,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,r):n?n.value=r:t.set(e,r),r},g=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var i,n=0,o=t.length;n<o;n++)!i&&n in t||(i||(i=Array.prototype.slice.call(t,0,n)),i[n]=t[n]);return e.concat(i||Array.prototype.slice.call(t))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkVideoRate=exports.Video=exports.VideoError=exports.VideoStatus=exports.NetworkErrorCode=exports.EventType=void 0;var E,P,b,k=require("@bilibili-live/fmp4.js"),T=require("@bilibili-live/web-player-common"),L=require("./video-utils");!function(e){e.VideoInfo="VideoInfo",e.MetaData="MetaData",e.CorePlayerCreated="CorePlayerCreated",e.Error="Error",e.LoadStart="LoadStart",e.Ended="Ended",e.NetworkResponse="NetworkResponse",e.FirstPacket="FirstPacket",e.FirstFrame="FirstFrame",e.SEIData="SEIData",e.Destroyed="Destroyed",e.WaitStart="WaitStart",e.WaitEnd="WaitEnd",e.WaitReport="WaitReport",e.Play="Play",e.Pause="Pause",e.WASMDecoderDegrade="WASMDecoderDegrade",e.MutePlay="MutePlay",e.NotAutoPlay="NotAutoPlay",e.FirstFrameTimeout="FirstFrameTimeout"}(E=exports.EventType||(exports.EventType={})),function(e){e[e.Timeout=11e3]="Timeout",e[e.ResponseError=11001]="ResponseError",e[e.DownloadInterrupt=11002]="DownloadInterrupt"}(P=exports.NetworkErrorCode||(exports.NetworkErrorCode={})),function(e){e.Initialize="Initialize",e.Loading="Loading",e.Playing="Playing",e.Pause="Pause",e.Destroyed="Destroyed"}(b=exports.VideoStatus||(exports.VideoStatus={}));var S,I=0,M={droppedFrames:0,decodedFrames:0,videoBufferLength:0,videoNetworkActivity:0,audioNetworkActivity:0,audioBufferLength:0},D={corePlayerType:T.CorePlayerType.NativePlayer,width:0,height:0,mimeType:"",volume:0,fps:0,encoder:"",videoDataRate:0,audioDataRate:0,audioSampleRate:0,audioChannel:"",videoSrc:""};!function(e){e[e.FirstFrameTimeout=92001]="FirstFrameTimeout"}(S=exports.VideoError||(exports.VideoError={}));var F=function(){function P(v,m){void 0===m&&(m={});var P,k=this;e.set(this,void 0),t.set(this,void 0),r.set(this,null),i.set(this,void 0),n.set(this,void 0),o.set(this,{mediaInfo:p({},D),realtimeInfo:p({},M)}),a.set(this,null),s.set(this,b.Initialize),u.set(this,[]),d.set(this,void 0),f.set(this,void 0),c.set(this,new T.EventBus),this.on=y(this,c,"f").on,this.once=y(this,c,"f").once,this.emit=function(e){for(var t,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];[E.VideoInfo,E.SEIData].includes(e)||y(k,n,"f").debug("video emit: ".concat(e,", handlers count: ").concat(y(k,c,"f").getHandlers(e).size)),(t=y(k,c,"f")).emit.apply(t,g([e],r,!1))},l.set(this,function(){if(y(k,t,"f").includes(".mp4"))return function(){};var e=setTimeout(function(){k.emit(E.Error,{type:E.FirstFrameTimeout,code:S.FirstFrameTimeout,errInfo:{url:y(k,t,"f")}})},1e4),r=function(){clearTimeout(e)};return k.once(E.FirstFrame,r),function(){r()}}),h.set(this,function(e){var i,a;y(k,n,"f").info("metadata fired"),y(k,o,"f").mediaInfo=Object.assign({},y(k,o,"f").mediaInfo,{videoSrc:y(k,t,"f"),width:e.width,height:e.height,mimeType:null===(i=y(k,r,"f"))||void 0===i?void 0:i.mimeType,fps:(0,T.roundNumber)(e.fps,0),encoder:null!==(a=e.encoder)&&void 0!==a?a:e.creator,videoDataRate:e.videodatarate,audioDataRate:e.audiodatarate,audioSampleRate:e.audiosamplerate,audioChannel:(0,L.parseAudioChannel)(e.audiochannel)}),k.emit(E.VideoInfo,k.getVideoInfo()),k.updateStatisticsInfo()}),w(this,i,I,"f"),I+=1,w(this,n,new Proxy(T.logger,{get:function(e,t){return["debug","info","warn","error"].includes(t)?function(r){e[t]("id ".concat(y(k,i,"f"),": ").concat(r))}:e[t]}}),"f"),w(this,t,v,"f"),w(this,d,m,"f"),w(this,e,N(null!==(P=m.wasmDecode)&&void 0!==P&&P),"f"),w(this,f,window.setTimeout(function(){k.load()},1),"f")}return Object.defineProperty(P.prototype,"status",{get:function(){return y(this,s,"f")},set:function(e){y(this,n,"f").info("Video status changed to ".concat(e)),w(this,s,e,"f")},enumerable:!1,configurable:!0}),P.prototype.delyLoad=function(){clearTimeout(y(this,f,"f"))},P.prototype.load=function(){var r;this.status!==b.Destroyed&&(y(this,n,"f").info("load src: ".concat(y(this,t,"f"),", opts: ").concat(JSON.stringify(y(this,d,"f")))),this.status=b.Loading,this.createCorePlayer(y(this,e,"f"),null===(r=y(this,d,"f"))||void 0===r?void 0:r.startTime),this.play().catch(function(e){T.logger.error(e)}))},P.prototype.play=function(){return v(this,void 0,Promise,function(){return m(this,function(t){switch(t.label){case 0:if(y(this,n,"f").info("video play"),null==y(this,e,"f"))return[2];if(this.status===b.Playing)return[2];t.label=1;case 1:return t.trys.push([1,3,,8]),[4,y(this,e,"f").play()];case 2:return t.sent(),this.status=b.Playing,[3,8];case 3:if("NotAllowedError"!==t.sent().name)return[2];y(this,n,"f").warn("try mute play"),y(this,e,"f").muted=!0,t.label=4;case 4:return t.trys.push([4,6,,7]),[4,y(this,e,"f").play()];case 5:return t.sent(),this.status=b.Playing,this.emit(E.MutePlay),[3,7];case 6:return t.sent(),y(this,n,"f").warn("can't auto play"),this.status=b.Pause,this.emit(E.NotAutoPlay),[3,7];case 7:return[3,8];case 8:return[2]}})})},P.prototype.pause=function(){y(this,n,"f").info("video pause"),null!=y(this,e,"f")&&this.status===b.Playing&&(y(this,e,"f").pause(),this.status=b.Pause)},P.prototype.seek=function(t){var r=t.forward,i=t.keepBuffer;if(y(this,n,"f").info("video seek, forward: ".concat(null!=r?r:"null",", keepBuffer: ").concat(null!=i?i:"null")),null!=y(this,e,"f")){var o=(0,T.remainBufferLength)(y(this,e,"f"));if(!(o<=0))if(null!=i&&i>0){if(o<i)return;y(this,e,"f").currentTime+=o-i}else if(null!=r&&r>0){if(r>o)return;y(this,e,"f").currentTime+=r}}},P.prototype.getSrc=function(){return y(this,t,"f")},P.prototype.volume=function(t){y(this,n,"f").info("video setVolume(".concat(t,")")),null!=y(this,e,"f")&&(y(this,e,"f").volume=(0,T.roundNumber)(t,2))},P.prototype.mute=function(t){null!=y(this,e,"f")&&(y(this,e,"f").muted=t)},P.prototype.getVideoEl=function(){return y(this,e,"f")},P.prototype.removeVideoEl=function(){var t,r;y(this,e,"f").remove(),null===(r=(t=y(this,e,"f")).destroy)||void 0===r||r.call(t)},P.prototype.getVideoInfo=function(){return y(this,o,"f").mediaInfo.volume=y(this,e,"f").volume,y(this,o,"f")},P.prototype.getNetworkState=function(){return y(this,r,"f")instanceof k.Hls7Player?y(this,r,"f").getHLSNetworkState():null},P.prototype.capturePic=function(t,r){var i,n,o=null===(n=(i=y(this,e,"f")).toDataURL)||void 0===n?void 0:n.call(i,t,r);return null!=o?o:V(y(this,e,"f"),t,r)},P.prototype.switchAudioTrack=function(t){var i,n;return y(this,r,"f")instanceof k.Hls7Player?null==(null===(i=y(this,r,"f"))||void 0===i?void 0:i.switchAudioTrack)?-1:(null===(n=y(this,r,"f"))||void 0===n||n.switchAudioTrack(t),(0,T.remainBufferLength)(y(this,e,"f"))):-1},P.prototype.getAudioTracks=function(){var e,t,i;return y(this,r,"f")instanceof k.Hls7Player&&null!==(i=null===(t=null===(e=y(this,r,"f"))||void 0===e?void 0:e.getAudioTracks)||void 0===t?void 0:t.call(e))&&void 0!==i?i:[]},P.prototype.destroy=function(t){var i,s;if(void 0===t&&(t=!1),t||this.removeVideoEl(),this.status!==b.Destroyed){this.status=b.Destroyed,y(this,n,"f").info("video destroyed, holdLastFrame: ".concat(t.toString())),clearTimeout(y(this,f,"f")),clearInterval(null!==(i=y(this,a,"f"))&&void 0!==i?i:0),w(this,o,{mediaInfo:p({},D),realtimeInfo:p({},M)},"f"),y(this,e,"f").pause(),y(this,u,"f").forEach(function(e){return null==e?void 0:e()});try{null===(s=y(this,r,"f"))||void 0===s||s.destroy()}catch(d){T.logger.error("corePlayer destroy error!!")}this.emit(E.Destroyed),y(this,c,"f").destroy()}},P.prototype.createCorePlayer=function(e,i){var n=this;if(null!=y(this,t,"f")){var a,s,f=!0===y(this,d,"f").wasmDecode?new window.BwpMediaSource:null!=window.MediaSource?new window.MediaSource:{},c=new URL(y(this,t,"f")).pathname;if(c.endsWith(".flv"))a=new k.fMp4Player(f,e),s=T.CorePlayerType.fMp4Player;else if(c.endsWith(".m3u8"))!0===y(this,d,"f").forceNativePlayer||null==window.MediaSource?(a=new k.NativePlayer(f,e),s=T.CorePlayerType.NativePlayer):(a=new k.Hls7Player(f,e),s=T.CorePlayerType.Hls7Player);else{if(!c.endsWith(".mp4"))throw new Error("Unsupported stream url: ".concat(c));a=new k.NativePlayer(f,e),s=T.CorePlayerType.NativePlayer}y(this,o,"f").mediaInfo=Object.assign({},y(this,o,"f").mediaInfo,{corePlayerType:s}),this.emit(E.LoadStart,{corePlayer:a,videoEl:e,src:y(this,t,"f")}),a.keepUsedBuffer=10,a.timeout=7e3,y(this,u,"f").push(this.bindEvents(a,e),y(this,l,"f").call(this)),null!=i&&i>0&&(a instanceof k.fMp4Player||a instanceof k.NativePlayer)&&(a.startTime=i),s===T.CorePlayerType.NativePlayer&&c.endsWith(".m3u8")?(0,L.redirectHLSV3)(y(this,t,"f")).then(function(e){a.src=e}).catch(function(e){a.src=y(n,t,"f"),T.logger.error(e)}):a.src=y(this,t,"f"),w(this,r,a,"f"),this.emit(E.CorePlayerCreated,{corePlayer:a,videoEl:e,src:y(this,t,"f")})}},P.prototype.updateStatisticsInfo=function(){var t=this,i=0;null!=y(this,a,"f")&&clearInterval(y(this,a,"f")),w(this,a,window.setInterval(function(){var n,a,s,u=null!==(s=null===(a=null===(n=y(t,e,"f"))||void 0===n?void 0:n.getVideoPlaybackQuality)||void 0===a?void 0:a.call(n))&&void 0!==s?s:{},d=u.droppedVideoFrames,f=void 0===d?0:d,c=u.totalVideoFrames,l=void 0===c?0:c,h=0;null!=y(t,r,"f")&&(h=y(t,r,"f").receivedBytes-i,Number.isNaN(h)&&(h=0),i=y(t,r,"f").receivedBytes),y(t,o,"f").realtimeInfo=Object.assign({},y(t,o,"f").realtimeInfo,{droppedFrames:f,decodedFrames:l,videoBufferLength:null==y(t,e,"f")?0:(0,T.roundNumber)((0,T.remainBufferLength)(y(t,e,"f")),3),videoNetworkActivity:h}),t.emit(E.VideoInfo,t.getVideoInfo())},1e3),"f")},P.prototype.bindEvents=function(e,t){var r=this,a=performance.now(),s=!1;e.onMetaData=function(e){y(r,h,"f").call(r,e),r.emit(E.MetaData,performance.now()-a),y(r,n,"f").info("after onMetaData mediaInfo: ".concat(JSON.stringify(y(r,o,"f").mediaInfo)))},e.onSeiData=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];r.emit.apply(r,g([E.SEIData],e,!1))},e.onFileFetched=function(e,t){var i=t.used,o=t.duration,a=2e3;0===o?a=2e3:o<=500&&(a=500),i>a&&y(r,n,"f").warn("fetch slowly: ".concat(e,", cost ").concat(i,"ms, duration: ").concat(o,"ms"))},e.onFirstResponse=function(e){r.emit(E.NetworkResponse,e)},e.onEndOfStream=function(){var e=Math.ceil((0,T.remainBufferLength)(t));(e<0||isNaN(e))&&(e=0),y(r,n,"f").warn("video onEndOfStream, bufLen: ".concat(e)),setTimeout(function(){t.dispatchEvent(new Event("ended"))},1e3*e)},e.onFirstPacket=function(){var e=performance.now()-a;y(r,n,"f").info("video first packet cost: ".concat(Math.round(e))),r.emit(E.FirstPacket,performance.now()-a)};var u=function(e,t,i){if(!s){s=!0;var o=(0,T.any2Str)({code:t,errInfo:i});y(r,n,"f").error("player core ".concat(e,", ").concat(o)),r.emit(E.Error,{code:t,errInfo:i}),r.destroy()}};e.onNetworkError=u.bind(this,"NetworkError"),e.onParserError=u.bind(this,"ParserError");var f=function(){var e=performance.now()-a;y(r,n,"f").info("video first frame cost: ".concat(Math.round(e))),r.emit(E.FirstFrame,e)};t.addEventListener("loadeddata",f);var c=function(){s||(s=!0,r.emit(E.Ended),r.destroy())};t.addEventListener("ended",c);var l=function(){if(!s){s=!0;var e=t.error,i={code:90002,errInfo:{code:null==e?void 0:e.code,msg:null==e?void 0:e.message}};y(r,n,"f").error("video native error: ".concat((0,T.any2Str)(i))),r.emit(E.Error,i),r.destroy()}};t.addEventListener("error",l);var p=W(t,e,{startCb:function(){y(r,n,"f").warn("video waiting!, bufferLen: ".concat((0,T.remainBufferLength)(t))),r.emit(E.WaitStart)},endCb:function(){y(r,n,"f").info("video playing"),r.emit(E.WaitEnd)},reportCb:function(e){r.emit(E.WaitReport,e)},id:y(this,i,"f")}),v=function(){r.emit(E.Play)};t.addEventListener("play",v);var m=function(){r.emit(E.Pause)};t.addEventListener("pause",m);var w=function(){};!0===y(this,d,"f").wasmDecode&&(w=function(){r.emit(E.WASMDecoderDegrade)},t.addEventListener("performance",w));var P=T.mediaAction.on("pause",function(){t.pause()}),b=T.mediaAction.on("play",function(){t.play().catch(function(e){T.logger.error(e)})});return function(){t.removeEventListener("loadeddata",f),t.removeEventListener("ended",c),t.removeEventListener("error",l),t.removeEventListener("play",v),t.removeEventListener("pause",m),t.removeEventListener("performance",w),p(),P(),b()}},P}();function N(e){var t=document.createElement(e?"bwp-video":"video");return t.id="video-".concat(Math.random().toString().slice(2)),t.style.cssText="\n    position: absolute;\n    top: 0;\n    left: 0;\n    z-index: 1;\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n  ",t.volume=.9,t.autoplay=!0,t.setAttribute("webkit-playsinline","true"),t.setAttribute("playsinline","true"),t}function W(e,t,r){var i=r.startCb,n=r.endCb,o=r.reportCb,a=r.id,s=!1,u=function t(){s=!0,e.removeEventListener("loadeddata",t)};e.addEventListener("loadeddata",u);var d=!1,f=function t(){e.removeEventListener("progress",t),d&&(d=!1,n())},c=function(){s&&(d=!0,i(),e.addEventListener("progress",f))},l=function(){e.removeEventListener("progress",f),d&&(d=!1,n())};e.addEventListener("waiting",c),e.addEventListener("playing",l);var h=new k.BufferDetector(e,1e3),p=0,v=0,m=0,y=0,w=performance.now(),g=function(){var r=performance.now(),i=t.receivedBytes-y;y=t.receivedBytes,o({count:h.waitedCount-p,duration:Math.round(h.waitedDuration-v),windowSize:Math.round(r-w),playTime:Math.round(e.currentTime-m),playedTime:Math.round(e.currentTime),receivedBytes:i,id:a}),p=h.waitedCount,v=h.waitedDuration,m=e.currentTime,w=r},E=window.setInterval(g,6e4),P=function(){g()};return window.addEventListener("beforeunload",P),function(){clearInterval(E),g(),window.removeEventListener("beforeunload",P),e.removeEventListener("playing",l),e.removeEventListener("waiting",c),e.removeEventListener("loadeddata",u),h.destroy()}}function C(e){if(e.videoHeight>e.videoWidth){var t=x(e);return e.insertAdjacentElement("afterend",t),t}return null}function x(e){var t=V(e),r=null;return(r=document.createElement("div")).style.cssText="\n    background-image: url(".concat(t,");\n    background-size: cover;\n    background-position: center;\n    width: 100%;\n    height: 100%;\n    filter: blur(35px);\n    position: absolute;\n    top: 0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n  "),r}function V(e,t,r){var i;void 0===t&&(t="image/jpeg"),void 0===r&&(r=.8);var n=document.createElement("canvas");return n.width=e.videoWidth,n.height=e.videoHeight,null===(i=n.getContext("2d"))||void 0===i||i.drawImage(e,0,0,n.width,n.height),n.toDataURL(t,r)}exports.Video=F,e=new WeakMap,t=new WeakMap,r=new WeakMap,i=new WeakMap,n=new WeakMap,o=new WeakMap,a=new WeakMap,s=new WeakMap,u=new WeakMap,d=new WeakMap,f=new WeakMap,c=new WeakMap,l=new WeakMap,h=new WeakMap,exports.checkVideoRate=C;
})()