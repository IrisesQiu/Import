/**
 * id: PvGc
 * path: ./round-player
 */

(function(require,module,exports) {
"use strict";var t,e,n,i,r,o,a,s,l,u,c,f=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function a(t){try{l(i.next(t))}catch(e){o(e)}}function s(t){try{l(i.throw(t))}catch(e){o(e)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(a,s)}l((i=i.apply(t,e||[])).next())})},d=this&&this.__generator||function(t,e){var n,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(l){s=[6,l],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}},h=this&&this.__classPrivateFieldSet||function(t,e,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(t,n):r?r.value=n:e.set(t,n),n},p=this&&this.__classPrivateFieldGet||function(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)},v=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RoundPlayer=exports.NonRoundStatus=void 0;var y,m=require("./dash-player"),w=v(require("../common/controller")),b=require("@bilibili-live/web-player-common"),E=require("../common/utils"),g=require("../common/connects"),P=v(require("@bilibili-live/web-player-track")),x=require("@bilibili-live/web-player-video");!function(t){t[t.Preround=-1]="Preround",t[t.Failed=-2]="Failed",t[t.Nonenabled=-3]="Nonenabled"}(y=exports.NonRoundStatus||(exports.NonRoundStatus={}));var T=function(){function v(v,T){var R=this;t.set(this,""),e.set(this,null),n.set(this,void 0),i.set(this,void 0),r.set(this,new b.EventBus),this.on=p(this,r,"f").on,this.emit=p(this,r,"f").emit,o.set(this,[]),a.set(this,null),s.set(this,""),l.set(this,!1),this.getVideoEl=function(){var t;return null===(t=p(R,e,"f"))||void 0===t?void 0:t.getVideoEl()},this.getPlayerInfo=function(){var n,i;return{guid:p(R,t,"f"),playingStatus:!(null!==(i=null===(n=p(R,e,"f"))||void 0===n?void 0:n.getVideoEl().paused)&&void 0!==i&&i),playSrc:p(R,s,"f"),quality:"0",qualityCandidates:[]}},this.play=function(){var t;null===(t=p(R,e,"f"))||void 0===t||t.play().catch(function(){})},this.pause=function(){var t;null===(t=p(R,e,"f"))||void 0===t||t.pause()},this.volume=function(t){var n;null===(n=p(R,e,"f"))||void 0===n||n.volume(t)},this.mute=function(t){var n;null===(n=p(R,e,"f"))||void 0===n||n.mute(t)},u.set(this,function(){return f(R,void 0,Promise,function(){var v,w,T,R,S,M,C,W,I,V=this;return d(this,function(q){switch(q.label){case 0:return p(this,l,"f")?[2]:(null===(W=p(this,e,"f"))||void 0===W||W.destroy(),v=(0,b.loading)(p(this,n,"f")),[4,k(p(this,i,"f").roomId)]);case 1:return w=q.sent(),v(),w.cid===y.Failed?[2]:w.cid<=0?(T=void 0,w.cid===y.Nonenabled&&(T=P.default.ErrorCode.RoomUnSettingRound),b.logger.warn("exit round cause: ".concat(y[w.cid])),this.emit("failed",w.cid,w.play_time,T),this.destroy(),[2]):(this.emit(b.ExternalEventType.StartPlayRound,w),[4,_(w.cid,w.bvid,p(this,i,"f").userId)]);case 2:if(null==(R=q.sent().dash))throw P.default.error(P.default.ErrorCode.RoomRoundNotExistDash,"dash url is not exist"),new Error("dash url is not exist");return h(this,e,new m.DashPlayer,"f"),p(this,e,"f").init(R,0===p(this,i,"f").userId?0:80).then(function(){var t;null===(t=p(V,e,"f"))||void 0===t||t.seek(w.play_time).catch(function(t){b.logger.error(t)})}).catch(function(t){b.logger.error(t)}),p(this,l,"f")?[2]:(h(this,t,(0,b.uuid)(),"f"),h(this,s,JSON.stringify(R),"f"),p(this,o,"f").forEach(function(t){return t()}),h(this,o,[],"f"),p(this,o,"f").push(p(this,c,"f").call(this,w.title),(0,g.connectUIandVideo)(this.ctrl,p(this,e,"f")),(0,g.connectVideoLoading)(p(this,e,"f"),p(this,n,"f"),p(this,a,"f")),(0,g.connectVideoPip)(p(this,e,"f"),this.ctrl),(0,g.connectMirror)(p(this,e,"f"),this.ctrl),b.EventBus.forwardEvent(p(this,e,"f"),p(this,r,"f"),[x.EventType.Play,x.EventType.Pause,x.EventType.LoadStart,x.EventType.MetaData,x.EventType.VideoInfo,x.EventType.FirstFrame,x.EventType.WaitEnd,x.EventType.WaitStart])),p(this,e,"f").once(x.EventType.Destroyed,function(){V.emit(x.EventType.Destroyed)}),S=null,M=function(){return f(V,void 0,Promise,function(){var t;return d(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),t=(0,b.loading)(p(this,n,"f")),[4,(0,E.backoffById)(w.bvid,4)];case 1:return e.sent(),null==t||t(),[3,3];case 2:return e.sent(),null==t||t(),[3,3];case 3:return p(this,u,"f").call(this).catch(function(t){b.logger.error(t),P.default.error(P.default.ErrorCode.RoomEnterRoundError,t)}),null==S||S.remove(),[2]}})})},p(this,e,"f").once(x.EventType.Ended,M),p(this,e,"f").once(x.EventType.Error,M),C=p(this,e,"f").getVideoEl(),p(this,e,"f").once(x.EventType.FirstFrame,function(){S=(0,x.checkVideoRate)(C)}),null===(I=p(this,e,"f"))||void 0===I||I.removeVideoEl(),p(this,n,"f").appendChild(C),[2])}})})}),c.set(this,function(t){var e,i="web-player-round-title";null===(e=document.querySelector(".".concat(i)))||void 0===e||e.remove();var r=document.createElement("div");return r.classList.add(i),r.textContent=t,r.style.cssText="\n      z-index: 2;\n      position: absolute;\n      right: 20px;\n      bottom: 20px;\n      pointer-events: none;\n      color: #aaa;\n      font-size: 14px;\n    ",p(R,n,"f").appendChild(r),function(){r.remove()}}),this.blockStream=function(){(0,E.blockStream)(p(R,e,"f"),function(){R.emit(x.EventType.Play)})},b.logger.info("enter round"),h(this,n,v,"f"),h(this,i,T,"f"),this.ctrl=new w.default(p(this,n,"f"),{userId:p(this,i,"f").userId,isMobile:!1,enableCtrlUI:p(this,i,"f").enableCtrlUI}),p(this,u,"f").call(this).catch(function(t){b.logger.error(t),P.default.error(P.default.ErrorCode.RoomEnterRoundError,t)}),this.ctrl.onRefresh(function(){p(R,u,"f").call(R).catch(function(t){b.logger.error(t),P.default.error(P.default.ErrorCode.RoomEnterRoundError,t)})})}return v.prototype.setTitlePageImg=function(t){h(this,a,t,"f")},v.prototype.capturePic=function(t,n){var i,r;return null!==(r=null===(i=p(this,e,"f"))||void 0===i?void 0:i.capturePic(t,n))&&void 0!==r?r:null},v.prototype.destroy=function(t){var n;void 0===t&&(t=!1),p(this,l,"f")||(h(this,l,!0,"f"),b.logger.info("round player destroy, holdLastFrame: ".concat(String(t))),null===(n=p(this,e,"f"))||void 0===n||n.destroy(t),p(this,o,"f").forEach(function(t){return t()}),h(this,o,[],"f"),this.ctrl.destroy(),p(this,r,"f").destroy())},v}();function k(t){return f(this,void 0,Promise,function(){var e;return d(this,function(n){switch(n.label){case 0:return[4,(0,b.ajax)("/live/getRoundPlayVideo?room_id=".concat(t,"&a=").concat(Date.now(),"&type=flv"))];case 1:if(e=n.sent(),Object.values(y).includes(e.cid))return[2,{play_time:e.play_time,cid:e.cid,bvid:e.bvid,title:e.title}];if(e.cid<=0)throw new Error("getRoundPlayVideo result parse failed: ".concat(JSON.stringify(e)));return[2,{play_time:e.play_time,cid:e.cid,bvid:e.bvid,title:e.title}]}})})}exports.RoundPlayer=T,t=new WeakMap,e=new WeakMap,n=new WeakMap,i=new WeakMap,r=new WeakMap,o=new WeakMap,a=new WeakMap,s=new WeakMap,l=new WeakMap,u=new WeakMap,c=new WeakMap;var _=function(t,e,n){return f(void 0,void 0,Promise,function(){return d(this,function(n){switch(n.label){case 0:return[4,(0,b.ajax)("https://api.bilibili.com/x/player/playurl?cid=".concat(t,"&bvid=").concat(e,"&fnval=16&platform=web"))];case 1:return[2,n.sent()]}})})};
})()