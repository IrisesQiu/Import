/**
 * id: fyPa
 * path: ./sticker
 */

(function(require,module,exports) {
"use strict";var t,e,i,n,r,o,s,h,a,c,f,l,d,p,g,u,w,_,m,b,k,v,y=this&&this.__assign||function(){return(y=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},x=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{a(n.next(t))}catch(e){o(e)}}function h(t){try{a(n.throw(t))}catch(e){o(e)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(s,h)}a((n=n.apply(t,e||[])).next())})},T=this&&this.__generator||function(t,e){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function h(h){return function(a){return function(h){if(i)throw new TypeError("Generator is already executing.");for(;o&&(o=0,h[0]&&(s=0)),s;)try{if(i=1,n&&(r=2&h[0]?n.return:h[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,h[1])).done)return r;switch(n=0,r&&(h=[2&h[0],r.value]),h[0]){case 0:case 1:r=h;break;case 4:return s.label++,{value:h[1],done:!1};case 5:s.label++,n=h[1],h=[0];continue;case 7:h=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===h[0]||2===h[0])){s=0;continue}if(3===h[0]&&(!r||h[1]>r[0]&&h[1]<r[3])){s.label=h[1];break}if(6===h[0]&&s.label<r[1]){s.label=r[1],r=h;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(h);break}r[2]&&s.ops.pop(),s.trys.pop();continue}h=e.call(t,s)}catch(a){h=[6,a],n=0}finally{i=r=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([h,a])}}},M=this&&this.__classPrivateFieldSet||function(t,e,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(t,i):r?r.value=i:e.set(t,i),i},E=this&&this.__classPrivateFieldGet||function(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)};Object.defineProperty(exports,"__esModule",{value:!0});var W,R=require("@bilibili-live/web-player-common");!function(t){t[t.Normal=1]="Normal",t[t.Text=2]="Text"}(W||(W={}));var B=(0,R.isWebPSupported)(),S=function(){return function(S){var C=this;this.container=S,t.set(this,void 0),e.set(this,void 0),i.set(this,null),n.set(this,0),r.set(this,0),o.set(this,new Map),s.set(this,new Map),h.set(this,[]),a.set(this,0),c.set(this,[]),f.set(this,!1),this.onSei=function(t){E(C,w,"f").call(C,t).catch(function(t){throw R.logger.error("贴纸加载失败"),new Error(t)})},this.onVideoInfo=function(i){i.width!==E(C,t,"f").width&&i.height!==E(C,t,"f").height&&(M(C,t,i,"f"),M(C,e,{width:0,height:0},"f"))},l.set(this,function(t){var e,i;E(C,o,"f").has(t.sticker_id)||E(C,f,"f")||(M(C,f,!0,"f"),t.sticker_type===W.Text?(null===(e=E(C,o,"f").get(t.sticker_id))||void 0===e||e.el.remove(),E(C,o,"f").set(t.sticker_id,E(C,d,"f").call(C,t))):(null===(i=E(C,o,"f").get(t.sticker_id))||void 0===i||i.el.remove(),E(C,o,"f").set(t.sticker_id,E(C,p,"f").call(C,t))))}),d.set(this,function(t){R.logger.info("create text sticker, id: ".concat(t.sticker_id));var i=new Image,o=document.createElement("div"),h=E(C,s,"f").get(t.sticker_id);return i.onload=function(){C.container.append(i),h.stretch.top_margin=(i.height-3)/2,h.stretch.bottom_margin=i.height/2,E(C,s,"f").set(t.sticker_id,y(y({},h),{width:i.width,height:i.height}));var a=E(C,g,"f").call(C,h,i.getBoundingClientRect(),t),c=document.createElement("span");c.innerText=t.sticker_title,c.style.cssText="\n        color: ".concat(t.sticker_title_color,";\n        font-size: ").concat(a.borderBottom+a.borderTop,"px;\n        position: absolute;\n        z-index: 4;\n        visibility: hidden;\n        word-break: keep-all;\n        white-space: no-wrap;\n        transform: scale(").concat(.3,");\n        transform-origin: 0 0;\n        white-space: nowrap;\n        cursor: default;\n        user-select: none;\n      "),C.container.append(c),c.style.cssText+="\n        top: -".concat(2.2*h.title.bottom_margin/i.height*(a.borderBottom+a.borderTop),"px;\n        left: -").concat(3*h.title.right_margin/i.width*a.width-.3*a.height,"px;\n      "),o.style.cssText="\n        transition: all .1s ease-in-out;\n        position: absolute;\n        z-index: 4;\n        border-style: solid;\n        border-color: transparent;\n        border-left-width: ".concat(a.borderLeft,"px;\n        border-right-width: ").concat(a.borderRight,"px;\n        border-top-width: ").concat(a.borderTop,"px;\n        border-bottom-width: ").concat(a.borderBottom,"px;\n        width: ").concat(c.getBoundingClientRect().width-a.borderRight+.5*a.height,"px;\n        border-image-source: url(").concat(h.url,");\n        border-image-repeat: stretch stretch;\n        border-image-slice: ").concat(h.stretch.top_margin," ").concat(h.stretch.right_margin," ").concat(h.stretch.bottom_margin," ").concat(h.stretch.left_margin," fill;\n      "),o.append(c),C.container.append(o);var l=E(C,e,"f").width,d=E(C,e,"f").height;l-=o.getBoundingClientRect().width,d=d-a.borderBottom-a.borderTop-c.getBoundingClientRect().height,t.display_width-t.sticker_right_offset<2?o.style.cssText+="\n            left: ".concat(E(C,r,"f")+l,"px;\n            top: ").concat(E(C,n,"f")+Math.min(t.sticker_top_offset*E(C,e,"f").height/t.display_height,d),"px;\n          "):o.style.cssText+="\n            left: ".concat(E(C,r,"f")+Math.min(t.sticker_left_offset*E(C,e,"f").width/t.display_width,l),"px;\n            top: ").concat(E(C,n,"f")+Math.min(t.sticker_top_offset*E(C,e,"f").height/t.display_height,d),"px;\n          "),c.style.visibility="visible",i.remove(),M(C,f,!1,"f")},i.src=B?h.url:h.url.replace(".webp",".gif"),i.style.visibility="hidden",{el:o,sei:t,width:0,height:0}}),p.set(this,function(t){R.logger.info("create img sticker, id: ".concat(t.sticker_id));var i=new Image,o=E(C,s,"f").get(t.sticker_id);return C.container.append(i),i.onload=function(){var h=E(C,e,"f").width,a=E(C,e,"f").height,c=E(C,g,"f").call(C,o,i.getBoundingClientRect(),t);a-=c.height,h-=c.width,i.style.cssText="\n          transition: all .1s ease-in-out;\n          position: absolute;\n          z-index: 4;\n        ",t.display_width-t.sticker_right_offset<2?i.style.cssText+="\n            left: ".concat(E(C,r,"f")+h,"px;\n            top: ").concat(E(C,n,"f")+Math.min(t.sticker_top_offset*E(C,e,"f").height/t.display_height,a),"px;\n          "):i.style.cssText+="\n            left: ".concat(E(C,r,"f")+Math.min(t.sticker_left_offset*E(C,e,"f").width/t.display_width,h),"px;\n            top: ").concat(E(C,n,"f")+Math.min(t.sticker_top_offset*E(C,e,"f").height/t.display_height,a),"px;\n          "),E(C,s,"f").set(t.sticker_id,y(y({},o),{width:i.width,height:i.height})),i.width=c.width,M(C,f,!1,"f")},i.src=B?o.url:o.url.replace(".webp",".gif"),{el:i,sei:t,width:0,height:0}}),this.batchUpdateStickerElement=function(){E(C,o,"f").forEach(function(t,e){E(C,u,"f").call(C,e)})},g.set(this,function(t,i,n){var r={width:0,height:0,top:0,left:0,borderLeft:0,borderRight:0,borderTop:0,borderBottom:0};if(r.height=E(C,e,"f").height*(n.sticker_bottom_offset-n.sticker_top_offset)/n.display_height/1.1,r.width=r.height*i.width/i.height,t.sticker_type===W.Text){var o=t,s=o.stretch,h=s.top_margin,a=s.left_margin,c=s.right_margin,f=s.bottom_margin,l=o.title,d=l.top_margin,p=l.left_margin;r.borderBottom=r.height/(f+h)*f,r.borderLeft=r.width/(a+c)*a,r.borderRight=r.width/(a+c)*c,r.borderTop=r.height/(f+h)*h,r.left=p*r.width/i.width,r.top=d*r.width/i.width}return r}),u.set(this,function(t){var i=E(C,o,"f").get(t),h=E(C,s,"f").get(t);if(null!=i&&null!=h){var a=E(C,g,"f").call(C,h,{width:h.width,height:h.height},i.sei),c=E(C,e,"f").width,f=E(C,e,"f").height;if(i.sei.sticker_type===W.Text){var l=h,d=i.el,p=d.firstElementChild;if(null==p)return void E(C,v,"f").call(C);var u=a.borderBottom+a.borderTop;p.style.fontSize=u.toString()+"px",p.innerText=String(i.sei.sticker_title);var w=p.getBoundingClientRect().width-a.borderRight+.5*a.height;w=w>0?w:0,d.style.cssText+="\n          border-left-width: ".concat(a.borderLeft,"px;\n          border-right-width: ").concat(a.borderRight,"px;\n          border-top-width: ").concat(a.borderTop,"px;\n          border-bottom-width: ").concat(a.borderBottom,"px;\n          width: ").concat(w,"px;\n        "),p.style.cssText+="\n          top: -".concat(2.2*l.title.bottom_margin/l.height*(a.borderBottom+a.borderTop),"px;\n          color: ").concat(i.sei.sticker_title_color,";\n          left: -").concat(3*l.title.right_margin/h.width*a.width-.3*a.height,"px;\n        "),c=c-a.borderLeft-a.borderRight-w,f=f-a.borderBottom-a.borderTop-p.getBoundingClientRect().height}else i.el.width=a.width,f-=a.height,c-=a.width;i.el.style.cssText+="\n        display: block;\n      ",i.sei.display_width-i.sei.sticker_right_offset<2?i.el.style.cssText+="\n          left: ".concat(E(C,r,"f")+c,"px;\n          top: ").concat(E(C,n,"f")+Math.min(i.sei.sticker_top_offset*E(C,e,"f").height/i.sei.display_height,f),"px;\n        "):i.el.style.cssText+="\n          left: ".concat(E(C,r,"f")+Math.min(i.sei.sticker_left_offset*E(C,e,"f").width/i.sei.display_width,c),"px;\n          top: ").concat(E(C,n,"f")+Math.min(i.sei.sticker_top_offset*E(C,e,"f").height/i.sei.display_height,f),"px;\n        ")}}),w.set(this,function(i){return x(C,void 0,Promise,function(){var n,r,h,f,d,p=this;return T(this,function(g){if(0===E(this,t,"f").width)return[2];if(!i.includes("LIVE_STICKER"))return[2];if(n=JSON.parse(i),0===E(this,e,"f").width&&(E(this,m,"f").call(this,n.LIVE_STICKER[0]),this.batchUpdateStickerElement()),clearTimeout(E(this,a,"f")),0===n.LIVE_STICKER.length)return E(this,v,"f").call(this),[2];for(E(this,o,"f").forEach(function(t,e){for(var i,r=!0,s=0,h=n.LIVE_STICKER;s<h.length;s++)h[s].sticker_id===e&&(r=!1);r&&(null===(i=t.el)||void 0===i||i.remove(),R.logger.info("remove sticker id: ".concat(t.sei.sticker_id)),E(p,o,"f").delete(e))}),r=0,h=n.LIVE_STICKER;r<h.length;r++)if(f=h[r],E(this,o,"f").has(f.sticker_id))(null==(d=E(this,o,"f").get(f.sticker_id))?void 0:d.sei.hash)!==f.hash&&(null!=d?(E(this,o,"f").set(f.sticker_id,y(y({},d),{sei:f})),E(this,u,"f").call(this,f.sticker_id)):(R.logger.info("2remove sticker id: ".concat(f.sticker_id)),E(this,o,"f").delete(f.sticker_id)));else if(E(this,s,"f").has(f.sticker_id))E(this,l,"f").call(this,f);else{if(E(this,c,"f").includes(f.group_id))return[2];E(this,c,"f").push(f.group_id),E(this,k,"f").call(this,f.group_id,f).catch(function(t){R.logger.error(t)})}return[2]})})}),_.set(this,function(){window.addEventListener("resize",E(C,b,"f")),document.addEventListener("fullscreenchange",E(C,b,"f")),E(C,h,"f").push(function(){window.removeEventListener("resize",E(C,b,"f")),document.removeEventListener("fullscreenchange",E(C,b,"f"))})}),this.calcDisplayInfo=function(){if(null!=E(C,i,"f")){var o=C.container.getBoundingClientRect().height,s=C.container.getBoundingClientRect().width,h=E(C,t,"f").width,a=E(C,t,"f").height;o/a<s/h?(M(C,e,{width:o*h/a,height:o*h/a*E(C,i,"f").display_height/E(C,i,"f").display_width},"f"),M(C,n,E(C,e,"f").width*E(C,i,"f").display_height/E(C,i,"f").display_width*.2,"f"),M(C,r,(s-E(C,e,"f").width)/2,"f")):(M(C,r,0,"f"),M(C,e,{width:s,height:s*E(C,i,"f").display_height/E(C,i,"f").display_width},"f"),M(C,n,(o-E(C,e,"f").width/7*4)/2+E(C,e,"f").width/14,"f"))}},m.set(this,function(t){M(C,i,t,"f"),null!=t&&C.calcDisplayInfo()}),this.destroy=function(){E(C,v,"f").call(C),M(C,f,!1,"f"),E(C,h,"f").forEach(function(t){return t()}),M(C,h,[],"f"),M(C,t,{width:0,height:0},"f"),M(C,e,{width:0,height:0},"f"),M(C,c,[],"f")},b.set(this,function(){C.calcDisplayInfo(),C.batchUpdateStickerElement()}),k.set(this,function(t,e){return x(C,void 0,Promise,function(){var i=this;return T(this,function(n){return R.ajax.disperse("/xlive/web-room/v1/stickers/getStickers",{scope:1e3*e.request_random_sec_range,expiresTime:performance.now()+1e3*e.request_random_sec_range}),(0,R.ajax)("/xlive/web-room/v1/stickers/getStickers?id=".concat(t)).then(function(t){for(var n=0,r=t.pic_stickers;n<r.length;n++){var o=r[n];E(i,s,"f").has(o.id)||E(i,s,"f").set(o.id,o)}for(var h=0,a=t.text_stickers;h<a.length;h++){var c=a[h];E(i,s,"f").has(c.id)||(c.stretch.top_margin*=3,c.stretch.left_margin*=3,c.stretch.right_margin*=3,c.stretch.bottom_margin*=3,E(i,s,"f").set(c.id,c))}E(i,l,"f").call(i,e)}).catch(function(t){R.logger.error(t)}),[2]})})}),v.set(this,function(){E(C,o,"f").forEach(function(t){var e=t.el;null==e||e.remove()}),E(C,o,"f").clear()}),M(this,t,{width:0,height:0},"f"),M(this,e,{width:0,height:0},"f"),E(this,_,"f").call(this)}}();exports.default=S,t=new WeakMap,e=new WeakMap,i=new WeakMap,n=new WeakMap,r=new WeakMap,o=new WeakMap,s=new WeakMap,h=new WeakMap,a=new WeakMap,c=new WeakMap,f=new WeakMap,l=new WeakMap,d=new WeakMap,p=new WeakMap,g=new WeakMap,u=new WeakMap,w=new WeakMap,_=new WeakMap,m=new WeakMap,b=new WeakMap,k=new WeakMap,v=new WeakMap;
})()