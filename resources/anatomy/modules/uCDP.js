/**
 * id: uCDP
 * path: @bilibili-live/web-player-playurl-parser
 */

(function(require,module,exports) {
"use strict";var t=this&&this.__assign||function(){return(t=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},e=this&&this.__classPrivateFieldSet||function(t,e,n,o,r){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?r.call(t,n):r?r.value=n:e.set(t,n),n},n=this&&this.__classPrivateFieldGet||function(t,e,n,o){if("a"===n&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?o:"a"===n?o.call(t):o?o.value:e.get(t)};Object.defineProperty(exports,"__esModule",{value:!0});var o=require("@bilibili-live/web-player-common"),r=1800,i=function(){function i(L){var W=this;this.source=L,a.set(this,{report_interval_sec:30}),c.set(this,o.P2PType.NONE),l.set(this,void 0),u.set(this,"0"),s.set(this,[]),f.set(this,i.Support_HEVC_No_Err?o.CodecType.HEVC:o.CodecType.AVC),p.set(this,""),h.set(this,[]),d.set(this,void 0),y.set(this,null),v.set(this,0),T.set(this,0),P.set(this,performance.now()),_.set(this,r),w.set(this,new o.EventBus),C.set(this,""),this.on=n(this,w,"f").on,this.once=n(this,w,"f").once,m.set(this,n(this,w,"f").emit),S.set(this,function(t){if(0!==n(W,T,"f"))return n(W,c,"f");var e=null!=t?t:W.source.playurl.p2p_data.p2p_type;return null!=o.wpd.P2PType&&(e=o.wpd.P2PType),null==window.MediaSource&&(e=o.P2PType.NONE),e!==o.P2PType.HLS_BILI&&e!==o.P2PType.HLS_NOT_P2P||W.hasHLSPlayerSupportStream()||(e=o.P2PType.NONE),e in o.P2PType||(e=o.P2PType.NONE),e}),g.set(this,function(t){return navigator.userAgent.includes("PlayStation")?[o.FormatType.TS]:t===o.ProtocolType.HTTP_STREAM?[o.FormatType.FLV]:null!=window.MediaSource||o.ua.isIOS()?[o.FormatType.FMP4,o.FormatType.TS]:[o.FormatType.TS]}),E.set(this,function(t){for(var e,r,i=n(W,g,"f").call(W,t),a=null,c=0,l=i;c<l.length;c++){var u=l[c];if(null!=(a=n(W,M,"f").call(W,{protocol:t,format:u,codec:o.CodecType.AVC})))break}for(var s=null,f=0,p=i;f<p.length;f++){u=p[f];if(null!=(s=n(W,M,"f").call(W,{protocol:t,format:u,codec:o.CodecType.HEVC})))break}var h=n(W,k,"f").call(W,null!==(e=null==a?void 0:a.accept_qn)&&void 0!==e?e:[],null!==(r=null==s?void 0:s.accept_qn)&&void 0!==r?r:[]),d=h.hevcAcceptQn,y=h.avcAcceptQn;return null!=s&&(s.accept_qn=d),null!=a&&(a.accept_qn=y),{avcCodec:a,hevcCodec:s}}),H.set(this,function(t,e){if(t===o.ProtocolType.HTTP_HLS){if(![o.P2PType.HLS_BILI,o.P2PType.HLS_NOT_P2P,o.P2PType.NONE].includes(n(W,c,"f")))return!0}else if(t===o.ProtocolType.HTTP_STREAM&&[o.P2PType.HLS_BILI,o.P2PType.HLS_NOT_P2P].includes(n(W,c,"f")))return!0;return!1}),M.set(this,function(e){var n,o,r,i=e.protocol,a=e.format,c=e.codec,l=null===(r=null===(o=null===(n=W.source.playurl.stream.find(function(t){return t.protocol_name===i}))||void 0===n?void 0:n.format)||void 0===o?void 0:o.find(function(t){return t.format_name===a}))||void 0===r?void 0:r.codec.find(function(t){var e=t.codec_name;return c===e});return null!=l?t(t({},l),{protocol:i,format:a}):null}),b.set(this,function(t,e){void 0===e&&(e=[]);var r=t.map(function(t){return{code:t,value:String(t),label:(i=n(W,l,"f").find(function(e){return e.qn===t}),a="",c=null===(e=null==i?void 0:i.attr_desc)||void 0===e?void 0:e.find(function(t){return"panorama"===t.attr_name}),null!=c&&(a=c.desc),(null!==(r=null==i?void 0:i.desc)&&void 0!==r?r:"")+a),codec:o.CodecType.AVC};var e,r,i,a,c}).filter(function(t){var e=t.label;return Boolean(e)}),a=(null!=e?e:[]).map(function(t){return{code:t,value:String(t),label:(r=n(W,l,"f").find(function(e){return e.qn===t}),i="",a=null===(e=null==r?void 0:r.attr_desc)||void 0===e?void 0:e.find(function(t){return"panorama"===t.attr_name}),null!=a&&(i=a.desc),(null!==(o=null==r?void 0:r.desc)&&void 0!==o?o:"")+i)};var e,o,r,i,a}).filter(function(t){var e=t.label;return Boolean(e)}).map(function(t){var e=t.code,n=t.value,r=t.label;return{code:e,value:"".concat(n,"_").concat(o.CodecType.HEVC),label:"".concat(null!=r?r:"","PRO"),codec:o.CodecType.HEVC}});return i.Support_HEVC_No_Err&&[o.EQuality.Origin,o.EQuality.K4].forEach(function(t){if(a.some(function(e){return e.code===t})){var e=a.find(function(e){return e.code===t});null!=e&&(e.label=e.label.replace(/PRO$/,""),r=r.filter(function(e){return e.code!==t}))}}),r.concat(a).sort(function(t,e){return e.code+(e.codec===o.CodecType.HEVC?1:0)-(t.code+(t.codec===o.CodecType.HEVC?1:0))})}),k.set(this,function(t,e){var n=W.source.playurl.dolby_qn;return null!=n&&(t=t.filter(function(t){return t!==n[0]})),null!=n&&(0,o.isSupportDolby)()?{hevcAcceptQn:e,avcAcceptQn:t=t.concat(n)}:{hevcAcceptQn:e,avcAcceptQn:t}});try{e(this,a,JSON.parse(L.conf_json),"f")}catch(V){o.logger.error(V)}e(this,l,L.playurl.g_qn_desc,"f"),e(this,c,n(this,S,"f").call(this),"f"),null!=window.MediaSource?e(this,d,[o.P2PType.HLS_BILI,o.P2PType.HLS_NOT_P2P].includes(n(this,c,"f"))?o.ProtocolType.HTTP_HLS:o.ProtocolType.HTTP_STREAM,"f"):e(this,d,o.ProtocolType.HTTP_HLS,"f"),this.useStream()}var a,c,l,u,s,f,p,h,d,y,v,T,P,_,w,C,m,S,g,E,H,M,b,k;return i.prototype.getCurPlayUrl=function(){if(performance.now()>n(this,P,"f")+1e3*n(this,_,"f"))throw new Error("source data is expired");return n(this,p,"f")},i.prototype.getCurStreamInfo=function(){var t,e,o=new URL(n(this,p,"f")),r=null!==(e=null===(t=/\/live-bvc\/\d+\/(live_.+?)[/.]/.exec(n(this,p,"f")))||void 0===t?void 0:t[1])&&void 0!==e?e:"";return{host:o.host,query:o.search,name:r,protocol:n(this,d,"f"),format:n(this,y,"f"),codec:n(this,f,"f"),p2pType:n(this,c,"f"),quality:n(this,u,"f"),timeshift:n(this,T,"f"),curAttrName:n(this,C,"f"),qualityDesc:n(this,l,"f")}},i.prototype.getCurQuality=function(){return n(this,u,"f")},i.prototype.getQualityDesc=function(t){var e,o=null!=t?t:n(this,u,"f");return null!==(e=n(this,s,"f").find(function(t){return t.value===o}))&&void 0!==e?e:null},i.prototype.getCurLine=function(){return n(this,v,"f")},i.prototype.getCurLineDesc=function(){var t=this;return this.getLineCandidates().find(function(e){return e.value===n(t,v,"f")})},i.prototype.getTimeShift=function(){return n(this,T,"f")},i.prototype.setTimeShift=function(t){e(this,T,t,"f")},i.prototype.setCurLine=function(t){if(0===n(this,h,"f").length)throw new Error("play url candidates is empty");e(this,v,t%this.getLineCandidates().length,"f");var o=n(this,h,"f")[n(this,v,"f")%n(this,h,"f").length];e(this,p,o.url,"f"),e(this,_,o.ttl>1?o.ttl:r,"f")},i.prototype.getPlayUrlCandates=function(){return n(this,h,"f")},i.prototype.getCurCodecType=function(){return n(this,f,"f")},i.prototype.getCurP2PType=function(){return n(this,c,"f")},i.prototype.getDynamicConfig=function(){return n(this,a,"f")},i.prototype.getQnCandidates=function(){return n(this,s,"f")},i.prototype.getAVCQnCandidates=function(){return this.getQnCandidates().filter(function(t){return t.codec===o.CodecType.AVC})},i.prototype.getLineCandidates=function(){return[{value:0,label:"主线"},{value:1,label:"备线1"},{value:2,label:"备线2"},{value:3,label:"备线3"}]},i.prototype.setCurP2PType=function(t){e(this,c,t,"f")},i.prototype.hasHLSPlayerSupportStream=function(){return Boolean(n(this,M,"f").call(this,{protocol:o.ProtocolType.HTTP_HLS,format:o.FormatType.FMP4,codec:o.CodecType.AVC}))},i.prototype.useStream=function(t){var i,a,l;void 0===t&&(t={});var P,w,m=null!==(i=t.protocol)&&void 0!==i?i:n(this,d,"f"),g=null!==(a=t.codec)&&void 0!==a?a:n(this,f,"f"),M=n(this,E,"f").call(this,m),k=M.avcCodec,L=M.hevcCodec;if(null==k||0===(null!==(l=k.url_info)&&void 0!==l?l:[]).length)throw new Error("can't find stream by protocol: ".concat(m,", codec: ").concat(null!=g?g:""));null!=(null==L?void 0:L.url_info)&&g===o.CodecType.HEVC?(P=L,w=o.CodecType.HEVC):(P=k,w=o.CodecType.AVC);var W=P.url_info.map(function(t){var e,n=t.host,o=t.extra,r=t.stream_ttl;return{url:"".concat(n).concat(P.base_url).concat(o),ttl:r,attr_name:null!==(e=P.attr_name)&&void 0!==e?e:""}});if(0===W.length)throw new Error("play url codec.hosts is empty");var V=n(this,v,"f")%W.length;e(this,C,W[V].attr_name,"f"),e(this,p,W[V].url,"f"),e(this,_,W[V].ttl>1?W[V].ttl:r,"f"),0!==n(this,T,"f")&&e(this,p,"".concat(n(this,p,"f"),"&tmshift=").concat(n(this,T,"f")),"f"),e(this,y,P.format,"f"),e(this,f,w,"f"),e(this,d,m,"f"),e(this,c,n(this,S,"f").call(this,t.expectP2PType),"f"),e(this,s,n(this,b,"f").call(this,k.accept_qn,null==L?void 0:L.accept_qn),"f"),e(this,u,"".concat(P.current_qn).concat(w===o.CodecType.HEVC?"_".concat(o.CodecType.HEVC):""),"f"),e(this,h,W,"f"),n(this,H,"f").call(this,m,n(this,c,"f"))&&e(this,c,o.P2PType.NONE,"f")},a=new WeakMap,c=new WeakMap,l=new WeakMap,u=new WeakMap,s=new WeakMap,f=new WeakMap,p=new WeakMap,h=new WeakMap,d=new WeakMap,y=new WeakMap,v=new WeakMap,T=new WeakMap,P=new WeakMap,_=new WeakMap,w=new WeakMap,C=new WeakMap,m=new WeakMap,S=new WeakMap,g=new WeakMap,E=new WeakMap,H=new WeakMap,M=new WeakMap,b=new WeakMap,k=new WeakMap,i.Support_HEVC_No_Err=(0,o.isHardSupportHEVC)(),i}();exports.default=i;
})()