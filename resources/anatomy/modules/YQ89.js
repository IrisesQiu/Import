/**
 * id: YQ89
 * path: ./biz-common
 */

(function(require,module,exports) {
"use strict";var e,o,t=this&&this.__awaiter||function(e,o,t,r){return new(t||(t=Promise))(function(n,i){function a(e){try{u(r.next(e))}catch(o){i(o)}}function l(e){try{u(r.throw(e))}catch(o){i(o)}}function u(e){var o;e.done?n(e.value):(o=e.value,o instanceof t?o:new t(function(e){e(o)})).then(a,l)}u((r=r.apply(e,o||[])).next())})},r=this&&this.__generator||function(e,o){var t,r,n,i,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(u){return function(l){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(t=1,r&&(n=2&l[0]?r.return:l[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,l[1])).done)return n;switch(r=0,n&&(l=[2&l[0],n.value]),l[0]){case 0:case 1:n=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,r=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===l[0]||2===l[0])){a=0;continue}if(3===l[0]&&(!n||l[1]>n[0]&&l[1]<n[3])){a.label=l[1];break}if(6===l[0]&&a.label<n[1]){a.label=n[1],n=l;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(l);break}n[2]&&a.ops.pop(),a.trys.pop();continue}l=o.call(e,a)}catch(u){l=[6,u],r=0}finally{t=n=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,u])}}},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.disableDanmaku=exports.dmVisualVibrate=exports.pressToOpenVideoInfoListener=exports.pause10SecBlockStream=exports.getUserId=exports.updateDanmakuSetting=exports.createContextmenuHandler=exports.ajaxWatcher=exports.initRoomInfoOrBlock=exports.loadRoomInfo=exports.initPlayer=exports.commonLogInfo=exports.downloadFile=exports.isSupported=exports.PlayerEnv=exports.ENV=void 0;var i,a=require("@bilibili-live/web-player-common"),l=n(require("@bilibili-live/web-player-track")),u=require("./ui-components/error-panel"),c=require("@bilibili-live/web-player"),s=require("./vibrate/vibrate_task");function d(){var e;return null!=Object.entries&&null!=Element.prototype.prepend&&("fetch"in window&&"ReadableStream"in window&&Boolean(null===(e=window.MediaSource)||void 0===e?void 0:e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'))||a.ua.isIOS())}function p(o,t){try{var r=document.createElement("a");r.download=t,r.style.display="none";var n=new Blob([o]);r.href=window.URL.createObjectURL(n),document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(e){a.logger.error("Failed to download file")}}function f(e){a.logger.info("".concat(e," version: ").concat(exports.ENV.VERSION,", current date: ").concat((new Date).toLocaleDateString(),", build time: ").concat(exports.ENV.BUILD_TIME)),a.logger.info("user agent: ".concat(navigator.userAgent)),setTimeout(function(){(0,a.ajax)("/xlive/web-room/v1/index/getIpInfo").then(function(e){a.logger.info("client ip info: ".concat(JSON.stringify(e)))}).catch(a.logger.error)},100)}function v(e,o){var t=(0,a.uuid)(),r=g();return a.logger.info("userId: ".concat(r)),l.default.initStaticInfo({uvid:t,uid:r,version:o+exports.ENV.VERSION,roomId:e}),a.userSetting.init(r),d()||(l.default.error(l.default.ErrorCode.UnsupportedPlayer,"UnsupportedPlayer"),a.logger.error("Unsupported Player")),{userId:r,uvid:t}}function m(e,o){return t(this,void 0,Promise,function(){return r(this,function(t){switch(t.label){case 0:return null==o?[3,2]:[4,o(e)];case 1:return[2,t.sent()];case 2:return[4,new Promise(function(o,t){(0,a.ajax)("//api.live.bilibili.com/xlive/web-room/v2/index/getRoomPlayInfo?room_id=".concat(e.roomId,"&protocol=0,1&format=0,1,2&codec=0,1&qn=").concat(e.qn,"&platform=").concat(e.isMobile?"html5":"web","&ptype=8&dolby=5").concat(e.isMobile?"":"&panorama=1"),{handleRes:o}).catch(t)})];case 3:return[2,t.sent()]}})})}function y(e,o,n){var i=e.roomId,l=e.isMobile;return t(this,void 0,Promise,function(){var e,t,c;return r(this,function(r){switch(r.label){case 0:return[4,m({roomId:i,qn:0,isMobile:l},n)];case 1:if(e=r.sent(),t=e.code,c=e.data,t===a.ApiErrorCode.AreaBlock)throw(0,u.createErrorPanel)(o,a.ApiErrorCode.AreaBlock,"Sorry, bilibili is currently not available in your country according to copyright restrictions<br/>非常抱歉，根据版权方要求，您所在的地区无法观看本直播"),new Error("RoomAreaBlock");return[2,c]}})})}function b(e,o){var t=o.duration,r=void 0===t?0:t,n=o.errMsg,i=void 0===n?"ApiError":n,a=o.apiUrl,u=void 0===a?"":a;"apiBizErr"===e?l.default.error(l.default.ErrorCode.ApiBiz,i,{apiUrl:u,extFields:[]}):"requestErr"===e?l.default.error(l.default.ErrorCode.ApiRequest,i,{apiUrl:u,extFields:[],sampleRate:.01}):"responseErr"===e?l.default.error(l.default.ErrorCode.ApiResponse,i,{apiUrl:u,extFields:[]}):"perf"===e&&l.default.perf(l.default.PerfCode.Api,r,{params:{apiUrl:u},extFields:[],sampleRate:.01})}function h(e,o){return{handleLogger:function(o){var t,r=a.logger.dump();switch(o){case"copy":return void(null===(t=navigator.clipboard)||void 0===t||t.writeText(r).catch(function(){}));case"download":return void p(r,"Bilibili-Live-HTML5-Player-EventLog-".concat(Date.now(),".txt"));case"show":e.show()}},handleVideoInfo:function(){o.show()}}}function x(e,o){var t={area:"danmakuArea",fontScale:"fontSize"},r=function(e){return e/100},n={opacity:r,fontScale:r,density:r,area:function(e){return e/4*100}};Object.entries(e).map(function(e){var o,r,i=e[0],a=e[1];return[null!==(o=t[i])&&void 0!==o?o:i,(null!==(r=n[i])&&void 0!==r?r:function(e){return e})(a)]}).forEach(function(e){var t,r=e[0],n=e[1];"display"===r?o[n?"show":"hide"]():o.set(((t={})[r]=n,t))})}function g(){return Number((0,a.getCookie)("DedeUserID"))}function w(e,o){var t=0,r=!1;a.mediaAction.on("play",function(){n()}),a.mediaAction.on("pause",function(){u()});var n=function(){var n,i;if(clearTimeout(t),r){r=!1;var l=e instanceof c.LivePlayer&&!0===(null===(n=e.replay)||void 0===n?void 0:n.isReplay);a.logger.info("reload when blocked stream, isReplay?: ".concat(String(l))),l?null===(i=e.replay)||void 0===i||i.reload():(e.destroy(),o.reload().catch(function(e){a.logger.error(e)}))}},i=e.on(c.VideoEventType.Play,n),l=e.ctrl.onChange(function(e,o){"playStatus"===e&&(o?n():u())}),u=function(){t=window.setTimeout(function(){a.logger.info("block stream because paused 10 sec"),r=!0,e.blockStream()},1e4)};return function(){i(),l(),clearTimeout(t),r=!1,a.mediaAction.destroy()}}function E(e){var o=[],t=function(t){o.push(performance.now()),(o=o.filter(function(e){return performance.now()-e<50})).length>=2&&(o=[],e.dispatchEvent(new MouseEvent("contextmenu",{clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY})))};return e.addEventListener("touchend",t),function(){e.removeEventListener("touchend",t)}}exports.ENV={VERSION:null!==(e="3.7.2")&&void 0!==e?e:"unknown",BUILD_TIME:null!==(o="2023/9/18 下午4:21:33")&&void 0!==o?o:"unknown",NODE_ENV:"production"},function(e){e.Activity="A",e.Room="R",e.Home="H",e.Mobile="M"}(i=exports.PlayerEnv||(exports.PlayerEnv={})),exports.isSupported=d,exports.downloadFile=p,exports.commonLogInfo=f,exports.initPlayer=v,exports.loadRoomInfo=m,exports.initRoomInfoOrBlock=y,exports.ajaxWatcher=b,exports.createContextmenuHandler=h,exports.updateDanmakuSetting=x,exports.getUserId=g,exports.pause10SecBlockStream=w,exports.pressToOpenVideoInfoListener=E;var I=function(e,o){var t=null;return e.on(a.ExternalEventType.SEIParseData,function(r,n,i){if(r===a.SEIType.B_LIVE_VIBRATION){var l=e.getVideoEl();null!=l&&(null==t&&(t=new s.VibrateTask(l,o)),t.input(n,i))}}),e.on(c.VideoEventType.Destroyed,function(){null==t||t.destroy(),t=null}),e.on(c.VideoEventType.WaitStart,function(){null==t||t.webXInputSetState(0,0)}),function(){null==t||t.destroy(),t=null}};function S(e){var o;null!=e.ctrl&&(e.ctrl.getCtrlUI().ctrlItemVisibility.danmaku=!1),null===(o=e.danmakuBiz)||void 0===o||o.hide()}exports.dmVisualVibrate=I,exports.disableDanmaku=S;
})()