/**
 * id: pBr6
 * path: ./live-player/live-player
 */

(function(require,module,exports) {
"use strict";var e,t,r,i,n,o,a,l,s,u,c,f,d,p,h,y,v,g,m,E,P,S,w,T,C,I,_,b,L,V,k=this&&this.__assign||function(){return(k=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},U=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(n,o){function a(e){try{s(i.next(e))}catch(t){o(t)}}function l(e){try{s(i.throw(e))}catch(t){o(t)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,l)}s((i=i.apply(e,t||[])).next())})},M=this&&this.__generator||function(e,t){var r,i,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(l){return function(s){return function(l){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(a=0)),a;)try{if(r=1,i&&(n=2&l[0]?i.return:l[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,l[1])).done)return n;switch(i=0,n&&(l=[2&l[0],n.value]),l[0]){case 0:case 1:n=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,i=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===l[0]||2===l[0])){a=0;continue}if(3===l[0]&&(!n||l[1]>n[0]&&l[1]<n[3])){a.label=l[1];break}if(6===l[0]&&a.label<n[1]){a.label=n[1],n=l;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(l);break}n[2]&&a.ops.pop(),a.trys.pop();continue}l=t.call(e,a)}catch(s){l=[6,s],i=0}finally{r=n=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}},N=this&&this.__classPrivateFieldGet||function(e,t,r,i){if("a"===r&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)},A=this&&this.__classPrivateFieldSet||function(e,t,r,i,n){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,r):n?n.value=r:t.set(e,r),r},D=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var i,n=0,o=t.length;n<o;n++)!i&&n in t||(i||(i=Array.prototype.slice.call(t,0,n)),i[n]=t[n]);return e.concat(i||Array.prototype.slice.call(t))},H=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LivePlayer=exports.LivePlayerEvent=exports.isBwpSupported=void 0;var x=require("@bilibili-live/web-player-common"),F=require("@bilibili-live/web-player-video"),Q=H(require("@bilibili-live/web-player-playurl-parser")),B=H(require("../common/controller")),W=H(require("./p2p-adapter")),q=require("../common/utils"),O=require("../common/track-video"),R=H(require("@bilibili-live/web-player-track")),K=H(require("./replay")),j=require("../common/connects"),J=H(require("./sticker")),G=require("./hevc-adapter"),z=require("./live-player-tool"),X=require("./switch-better-line"),Y=require("./retry-strategy"),Z=require("./panorama"),$=require("./hevc-adapter");Object.defineProperty(exports,"isBwpSupported",{enumerable:!0,get:function(){return $.isBwpSupported}});var ee,te=((e={})[x.P2PType.HLS_BILI]=x.P2PType.HLS_NOT_P2P,e[x.P2PType.FLV_QVB]=x.P2PType.NONE,e[x.P2PType.HLS_NOT_P2P]=x.P2PType.HLS_NOT_P2P,e[x.P2PType.NONE]=x.P2PType.NONE,e);!function(e){e.Failed="liveplayer-failed",e.LiveStatusChange="liveplayer-status-change",e.Destroyed="liveplayer-destroyed",e.VideoError="VideoError"}(ee=exports.LivePlayerEvent||(exports.LivePlayerEvent={}));var re=function(){function e(e,D,H){var W,j=this;this.container=e,this.opts=D,this.socket=H,t.set(this,""),r.set(this,""),i.set(this,null),n.set(this,null),this.playUrlParser=null,o.set(this,0),this.replay=null,a.set(this,[]),l.set(this,[]),s.set(this,null),u.set(this,!1),c.set(this,null),f.set(this,null),d.set(this,"Fetch"),p.set(this,void 0),h.set(this,null),y.set(this,function(){}),v.set(this,!1),g.set(this,new x.EventBus),this.on=N(this,g,"f").on,this.once=N(this,g,"f").once,m.set(this,N(this,g,"f").emit),E.set(this,new Set),P.set(this,null),S.set(this,null),w.set(this,function(e){return U(j,void 0,Promise,function(){var t,r,i,a,s=this;return M(this,function(u){switch(u.label){case 0:return A(this,o,e,"f"),this.opts.roomId=e,x.logger.info("live player init roomId: ".concat(e)),null!=this.opts.roomInfo?[3,2]:[4,N(this,I,"f").call(this)];case 1:return u.sent(),[3,3];case 2:if(A(this,n,this.opts.roomInfo,"f"),null==N(this,n,"f").playurl_info.playurl)return N(this,m,"f").call(this,ee.Failed,R.default.ErrorCode.PlayUrlNull),x.logger.error("playUrlInfo.playurl is null"),[2];this.playUrlParser=ce(N(this,n,"f").playurl_info,{userId:this.opts.userId,ownerId:N(this,n,"f").uid,isMobile:null!==(t=this.opts.isMobile)&&void 0!==t&&t}),u.label=3;case 3:return this.reload(),null!=(null===(r=N(this,n,"f"))||void 0===r?void 0:r.live_time)&&N(this,l,"f").push(ne(N(this,n,"f").live_time,this.ctrl.getCtrlUI())),null!=N(this,n,"f")&&!0!==this.opts.isMobile&&this.opts.enableCtrlUI&&(this.replay=new K.default(this.container,{live_time:null===(i=N(this,n,"f"))||void 0===i?void 0:i.live_time,rid:null===(a=N(this,n,"f"))||void 0===a?void 0:a.room_id},this.socket,this.ctrl),this.replay.on("timeShiftChange",function(e){s.tmShiftHandler(e),s.reload(),e>0&&A(s,S,null,"f")}),this.enableReplay()&&this.replay.init()),[2]}})})}),this.tmShiftHandler=function(e){var t,r,i,n=j.playUrlParser;if(null!=j.replay&&null!=n){var o=n.getCurP2PType(),a=n.getCurStreamInfo().protocol,l=x.ProtocolType.HTTP_HLS,s=x.P2PType.HLS_NOT_P2P,u=n.getCurStreamInfo().timeshift;0!==e?(0===u&&(j.replay.bakState={p2pType:o,protocol:a}),(null!==(t=j.replay.bakState.p2pType)&&void 0!==t?t:o)>0&&(n.setCurP2PType(x.P2PType.HLS_BILI),s=x.P2PType.HLS_BILI)):(s=null!==(r=j.replay.bakState.p2pType)&&void 0!==r?r:o,n.setCurP2PType(s),l=null!==(i=j.replay.bakState.protocol)&&void 0!==i?i:a,j.replay.bakState={}),n.setTimeShift(e),n.useStream({protocol:l,expectP2PType:s})}},T.set(this,function(e){var t,r,i=null!==(r=null===(t=j.playUrlParser)||void 0===t?void 0:t.getLineCandidates().length)&&void 0!==r?r:0,n=new X.SwitchBetterLine(e.getVideoEl(),{lineNum:i}),o=e.on(F.EventType.WaitStart,function(){var t,r,i;if(!0!==(null===(t=j.replay)||void 0===t?void 0:t.isReplay)&&n.getNeedSwitchLine()){var o=performance.now(),a=navigator.connection;j.switchLine(X.SwitchBetterLine.switchNum,!1),R.default.custom(R.default.CustomCode.SwitchLine,{switchNum:X.SwitchBetterLine.switchNum,videoCurrentTime:e.getVideoEl().currentTime,interval:Math.floor((o-X.SwitchBetterLine.lastSwitchTime)/1e3),downlink:null!==(r=null==a?void 0:a.downlink)&&void 0!==r?r:-1,rtt:null!==(i=null==a?void 0:a.rtt)&&void 0!==i?i:-1}),x.logger.warn("waiting auto switch line to ".concat(X.SwitchBetterLine.switchNum))}});N(j,a,"f").push(n.destroy),N(j,a,"f").push(o)}),C.set(this,function(){N(j,a,"f").forEach(function(e){return e()}),A(j,a,[],"f")}),I.set(this,(0,q.retry)(function(e){return U(j,void 0,Promise,function(){var t,r,i,a,l,s,u,f,d,p,h,y,v,g,E,P,S;return M(this,function(w){switch(w.label){case 0:return t=this.playUrlParser,r=null!==(p=null===(d=null==t?void 0:t.getQualityDesc(t.getCurQuality()))||void 0===d?void 0:d.code)&&void 0!==p?p:0,null!=e&&(r=e),(0,q.loadingOrCoverImg)(this.container,N(this,c,"f")),i=null!==(y=null===(h=this.playUrlParser)||void 0===h?void 0:h.getCurLine())&&void 0!==y?y:0,a=(null!==(g=null===(v=this.playUrlParser)||void 0===v?void 0:v.getCurStreamInfo())&&void 0!==g?g:{}).timeshift,x.logger.info("updateRoomInfo quality: ".concat(r,", line: ").concat(i)),[4,this.opts.roomInfoProvider({roomId:N(this,o,"f"),qn:r,isMobile:null!==(E=this.opts.isMobile)&&void 0!==E&&E})];case 1:return l=w.sent(),s=l.code,u=l.data,f=l.message,s===x.ApiErrorCode.AreaBlock?(N(this,m,"f").call(this,ee.Failed,x.ApiErrorCode.AreaBlock,f),[2]):1!==u.live_status?((0,x.unloading)(),N(this,m,"f").call(this,ee.LiveStatusChange,u.live_status),[2]):null==u.playurl_info?((0,x.unloading)(),this.playUrlParser=null,x.logger.info("playUrlInfo is null"),[2]):(A(this,n,u,"f"),x.logger.debug("room info: ".concat(JSON.stringify(u))),null==u.playurl_info.playurl?(N(this,m,"f").call(this,ee.Failed,R.default.ErrorCode.PlayUrlNull),x.logger.error("playUrlInfo.playurl is null"),[2]):(this.playUrlParser=ce(N(this,n,"f").playurl_info,{userId:this.opts.userId,ownerId:u.uid,isMobile:null!==(P=this.opts.isMobile)&&void 0!==P&&P}),null===(S=this.playUrlParser)||void 0===S||S.setCurLine(i),this.tmShiftHandler(null!=a?a:0),[2]))}})})},[0,1,3,5,10,20,30,60,90,120].map(function(e){return 1e3*e}))),_.set(this,function(e,n){e.once(F.EventType.FirstFrame,function(){var o,l,c=null;if(N(j,a,"f").push(function(){null==c||c.remove()}),N(j,E,"f").forEach(function(t){t!==e&&(t.destroy(),N(j,E,"f").delete(t))}),A(j,t,(0,x.uuid)(),"f"),A(j,r,n,"f"),N(j,u,"f"))e.destroy();else{null===(o=N(j,i,"f"))||void 0===o||o.removeVideoEl();var f=e.getVideoEl();j.container.appendChild(f),A(j,i,e,"f"),!0!==j.opts.isMobile&&(c=(0,F.checkVideoRate)(e.getVideoEl())),null===(l=N(j,s,"f"))||void 0===l||l.success(),N(j,y,"f").call(j),A(j,y,ae(e,N(j,h,"f")),"f")}})}),b.set(this,function(e){var t,r,i,n,o=(0,q.maxRetryChecker)(e);e.once(F.EventType.Ended,function(){return U(j,void 0,void 0,function(){return M(this,function(t){return e.destroy(),o()?(l().catch(x.logger.error),[2]):(x.logger.error("retry over 1 min"),N(this,m,"f").call(this,ee.Failed,R.default.ErrorCode.RetryMaxTime),[2])})})}),e.once(F.EventType.Error,function(t){return U(j,void 0,void 0,function(){var r,i,n;return M(this,function(a){return N(this,m,"f").call(this,ee.VideoError,t),e.destroy(),x.logger.error(t),o()?(r=(0,q.loadingOrCoverImg)(this.container,N(this,c,"f")),!0===(null===(i=this.replay)||void 0===i?void 0:i.isReplay)?[2]:(Q.default.Support_HEVC_No_Err&&t.code===R.default.ErrorCode.NativeVideoError?[3,4].includes(t.errInfo.code):t.code===R.default.ErrorCode.ErrorMseOpen&&/NotSupportedError.+hvc1/.test(t.errInfo.info))?(Q.default.Support_HEVC_No_Err=!1,null===(n=this.playUrlParser)||void 0===n||n.useStream({codec:x.CodecType.AVC}),this.reload(),[2]):(l().then(r).catch(function(e){x.logger.error(e),r()}),[2])):(N(this,m,"f").call(this,ee.Failed,R.default.ErrorCode.RetryMaxTime),[2])})})}),x.logger.debug("max retry times：".concat(null!==(r=null===(t=j.playUrlParser)||void 0===t?void 0:t.getPlayUrlCandates().length)&&void 0!==r?r:0));var a=Math.min(null!==(n=null===(i=j.playUrlParser)||void 0===i?void 0:i.getPlayUrlCandates().length)&&void 0!==n?n:0,4),l=function(){return U(j,void 0,Promise,function(){var e,t,r,i;return M(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,7]),[4,(0,q.backoffById)(this.playUrlParser,a)];case 1:if(e=n.sent(),null!=this.playUrlParser)if((t=(0,Y.useRetryStrategy)(this.playUrlParser,e,a))===Y.RetryStrategies.SwitchLine)N(this,m,"f").call(this,x.ExternalEventType.SwitchLine,this.playUrlParser.getCurLine());else if(t===Y.RetryStrategies.Failed)throw new Error("not supported hls protocol stream");return[3,7];case 2:r=n.sent(),x.logger.error(r),n.label=3;case 3:return n.trys.push([3,5,,6]),[4,N(this,I,"f").call(this)];case 4:return n.sent(),[3,6];case 5:throw i=n.sent(),N(this,m,"f").call(this,ee.Failed,R.default.ErrorCode.RoomP0ApiFetchError),this.destroy(),i;case 6:return[3,7];case 7:return this.reload(),[2]}})})}}),L.set(this,function(e){var t=(0,x.seiKeyComparator)(x.SEIType.LIVE_SEI_CHANNEL),r=(0,x.seiKeyComparator)(x.SEIType.B_LIVE_VIBRATION),i=(0,x.seiKeyComparator)(x.SEIType.LIVE_SEI_PC_LINK),n=(0,x.seiKeyComparator)(x.SEIType.BVC_KUAWAN____TS),o=(0,x.seiKeyComparator)(x.SEIType.BVCLIVESTREAMHOP),a=(0,x.seiKeyComparator)(x.SEIType.BILILIVESUBTITLE),l=(0,x.seiKeyComparator)(x.SEIType.BVC__CANVAS_DATA);return e.once(F.EventType.Destroyed,function(){N(j,m,"f").call(j,F.EventType.Destroyed)}),[x.EventBus.forwardEvent(e,N(j,g,"f"),[F.EventType.Play,F.EventType.Pause,F.EventType.LoadStart,F.EventType.MetaData,F.EventType.FirstFrame,F.EventType.WaitStart,F.EventType.WaitEnd,F.EventType.NotAutoPlay,F.EventType.MutePlay,F.EventType.CorePlayerCreated]),e.on(F.EventType.VideoInfo,function(e){var t,r;N(j,m,"f").call(j,F.EventType.VideoInfo,{mediaInfo:k(k({},e.mediaInfo),{corePlayerType:"".concat(null!==(r=null===(t=e.mediaInfo)||void 0===t?void 0:t.corePlayerType)&&void 0!==r?r:""," (").concat(N(j,d,"f"),")")}),realtimeInfo:k(k({},e.realtimeInfo),{latency:N(j,S,"f")})})}),e.on(F.EventType.SEIData,function(){for(var e=[],s=0;s<arguments.length;s++)e[s]=arguments[s];t(e[2])?N(j,m,"f").call(j,x.ExternalEventType.SEIParseData,x.SEIType.LIVE_SEI_CHANNEL,(0,x.uint8ArrayToString)(e[3])):r(e[2])?N(j,m,"f").call(j,x.ExternalEventType.SEIParseData,x.SEIType.B_LIVE_VIBRATION,e[1],e[3]):i(e[2])?N(j,m,"f").call(j,x.ExternalEventType.SEIParseData,x.SEIType.LIVE_SEI_PC_LINK,(0,x.uint8ArrayToString)(e[3])):n(e[2])?N(j,m,"f").call(j,x.ExternalEventType.SEIParseData,x.SEIType.BVC_KUAWAN____TS,(0,x.uint8ArrayToString)(e[3])):o(e[2])?N(j,V,"f").call(j,e):a(e[2])?N(j,m,"f").call(j,x.ExternalEventType.SEIParseData,x.SEIType.BILILIVESUBTITLE,e[1],(0,x.uint8ArrayToString)(e[3])):l(e[2])?N(j,m,"f").call(j,x.ExternalEventType.SEIParseData,x.SEIType.BVC__CANVAS_DATA,e[1],(0,x.uint8ArrayToString)(e[3])):N(j,m,"f").call(j,F.EventType.SEIData,e)}),e.once(F.EventType.WASMDecoderDegrade,function(){var e=j.playUrlParser;if(null!=e){var t=e.getQualityDesc();if((null==t?void 0:t.codec)===x.CodecType.HEVC){var r=(0,z.getHEVCDowngradeQn)(t,e.getAVCQnCandidates());j.switchQuality(r,"CPU负载较高，")}}})]}),this.play=function(){var e;null===(e=N(j,i,"f"))||void 0===e||e.play().catch(function(){})},this.pause=function(){var e;null===(e=N(j,i,"f"))||void 0===e||e.pause()},this.volume=function(e){var t;null===(t=N(j,i,"f"))||void 0===t||t.volume(e)},this.switchAudioTrack=function(e){var t,r;return null!==(r=null===(t=N(j,i,"f"))||void 0===t?void 0:t.switchAudioTrack(e))&&void 0!==r?r:-1},this.getAudioTracks=function(){var e;return null===(e=N(j,i,"f"))||void 0===e?void 0:e.getAudioTracks()},this.mute=function(e){var t;null===(t=N(j,i,"f"))||void 0===t||t.mute(e)},this.enableReplay=function(){return null!=N(j,n,"f")&&null!=j.playUrlParser&&!(!N(j,n,"f").all_special_types.includes(19)||!j.playUrlParser.hasHLSPlayerSupportStream())},V.set(this,function(e){var t,r,n;if(!document.hidden&&!0!==(null===(t=j.replay)||void 0===t?void 0:t.isReplay)){var o=null===(r=N(j,i,"f"))||void 0===r?void 0:r.getVideoEl();if(null!=o&&!o.paused){var a=[];try{a=JSON.parse((0,x.uint8ArrayToString)(e[3]))}catch(p){return void x.logger.error("bvc latency sei解析失败")}var l=j.playUrlParser,s=null!==(n=null==l?void 0:l.getCurStreamInfo())&&void 0!==n?n:{},u=s.format,c=s.p2pType,f=e[1],d=Math.round(1e3*(f-o.currentTime)+Date.now());a.length>0&&A(j,S,d-a[0].curr_ms,"f"),de(a.concat({curr_ms:d,author:"web_player",author_ver:"v".concat("3.7.2"),buffer_ms:Math.round(1e3*(0,x.remainBufferLength)(o)),protocol:null!=c&&c===x.P2PType.HLS_BILI?"webrtc":"http",muxer:u})),pe(function(){A(j,S,null,"f")})}}}),!0!==D.isMobile&&(e.style.overflow="hidden"),this.ctrl=new B.default(e,{userId:D.userId,isMobile:null!==(W=this.opts.isMobile)&&void 0!==W&&W,enableCtrlUI:D.enableCtrlUI}),N(this,l,"f").push(ie(this.ctrl,this,function(){N(j,m,"f").call(j,x.ExternalEventType.Reload)})),A(this,p,(0,O.createVideoTracker)(),"f"),N(this,w,"f").call(this,this.opts.roomId).catch(function(e){x.logger.error(e),R.default.error(R.default.ErrorCode.RoomEnterLiveError,e)})}return e.prototype.reload=function(){var e,t,r,i=this;if(!N(this,u,"f")){x.logger.info("live player load roomId: ".concat(N(this,o,"f")));var l=N(this,o,"f");if(null!=N(this,n,"f")&&0!==l&&null!=this.playUrlParser){var s,h=this.playUrlParser;null==N(this,f,"f")&&A(this,f,h.getCurQuality(),"f");try{s=h.getCurPlayUrl()}catch(w){return x.logger.error(w),void N(this,I,"f").call(this).then(function(){i.reload()}).catch(function(e){x.logger.error(e)})}if(!N(this,u,"f")){var y=h.getCurStreamInfo();R.default.updateDynamicInfo({p2pType:y.p2pType,sHost:y.host,sQuery:y.query,sProtocol:y.protocol,sCodec:y.codec,sName:y.name,quality:y.quality,sFormat:null!==(r=y.format)&&void 0!==r?r:"",line:this.playUrlParser.getCurLine()},!0);var g=R.default.fixedDynamicFieldsVerIns();x.logger.info("current stream info: ".concat(JSON.stringify(y))),N(this,C,"f").call(this);var m=new F.Video(s,{wasmDecode:h.getCurCodecType()===x.CodecType.HEVC&&!(0,x.isHardSupportHEVC)()&&(0,G.isWASMSupportHEVC)(),forceNativePlayer:"panorama"===h.getCurStreamInfo().curAttrName||navigator.userAgent.includes("PlayStation")});y.codec===x.CodecType.HEVC&&g.updateDynamicInfo({videoTag:m.getVideoEl().tagName}),(e=N(this,a,"f")).push.apply(e,fe(this.playUrlParser,this.container,l.toString(),m.getVideoEl(),this.ctrl)),N(this,E,"f").add(m),se(this.ctrl.getCtrlUI(),h,x.wpd.SupportHEVC||(0,x.isHardSupportHEVC)()||N(this,v,"f")),N(this,T,"f").call(this,m),ue(m,this,this.container),N(this,_,"f").call(this,m,s),N(this,b,"f").call(this,m),N(this,p,"f").call(this,m),(t=N(this,a,"f")).push.apply(t,D([(0,j.connectUIandVideo)(this.ctrl,m),oe(m),(0,j.connectVideoLoading)(m,this.container,N(this,c,"f")),(0,j.connectVideoPip)(m,this.ctrl),(0,j.connectMirror)(m,this.ctrl)],N(this,L,"f").call(this,m),!1));var S=h.getCurP2PType();(0,W.default)({video:m,type:S,roomId:l,interval:h.getDynamicConfig().report_interval_sec}).then(function(e){var t;null!=e&&(A(i,P,e,"f"),N(i,p,"f").setP2PInstance(m,e),N(i,a,"f").push(function(){A(i,P,null,"f")})),A(i,d,(t={},t[x.P2PType.HLS_BILI]="SistersFetcher",t[x.P2PType.FLV_QVB]="QVBFetcher",t[x.P2PType.HLS_NOT_P2P]="Fetch",t[x.P2PType.NONE]="Fetch",t)[S],"f")}).catch(function(e){var t;A(i,d,"Fetch","f"),h.setCurP2PType(te[S]),g.updateDynamicInfo({p2pType:te[S]}),x.logger.error(e),null===(t=N(i,P,"f"))||void 0===t||t.destroy(),A(i,P,null,"f")})}}}},e.prototype.setTitlePageImg=function(e){A(this,c,e,"f")},e.prototype.setAutoSyncCfg=function(e){/chrome\/91/g.test(navigator.userAgent.toLowerCase())||(A(this,h,e,"f"),null!=N(this,i,"f")&&(N(this,y,"f").call(this),A(this,y,ae(N(this,i,"f"),e),"f")))},e.prototype.getPlayerInfo=function(){var e,n,o,a,l,s,u,c;return{guid:N(this,t,"f"),playingStatus:!(null===(n=null===(e=N(this,i,"f"))||void 0===e?void 0:e.getVideoEl().paused)||void 0===n||n),playSrc:N(this,r,"f"),quality:null!==(a=null===(o=this.playUrlParser)||void 0===o?void 0:o.getCurQuality())&&void 0!==a?a:"",qualityCandidates:null!==(s=null===(l=this.playUrlParser)||void 0===l?void 0:l.getQnCandidates())&&void 0!==s?s:[],timeShift:null!==(c=null===(u=this.playUrlParser)||void 0===u?void 0:u.getTimeShift())&&void 0!==c?c:0}},e.prototype.getVideoEl=function(){var e;return null===(e=N(this,i,"f"))||void 0===e?void 0:e.getVideoEl()},e.prototype.getP2PTransport=function(){var e,t;return{downloadExtraFile:null===(e=N(this,P,"f"))||void 0===e?void 0:e.downloadExtraFile.bind(N(this,P,"f")),shareExtraFile:null===(t=N(this,P,"f"))||void 0===t?void 0:t.shareExtraFile.bind(N(this,P,"f"))}},e.prototype.blockStream=function(){var e=this;(0,q.blockStream)(N(this,i,"f"),function(){N(e,m,"f").call(e,F.EventType.Play)})},e.prototype.discardFrame=function(e){var t,r=null===(t=N(this,i,"f"))||void 0===t?void 0:t.getVideoEl();null!=r&&(r.currentTime+=e)},e.prototype.remainBufferLength=function(){var e,t=null===(e=N(this,i,"f"))||void 0===e?void 0:e.getVideoEl();return null==t?0:(0,x.remainBufferLength)(t)},e.prototype.showHEVCQuality=function(e){var t=this;if(!(0,x.isHardSupportHEVC)()){var r=this.playUrlParser;if(null!=r)if(e)(0,G.loadWASMDecoder)().then(function(){null!=t.playUrlParser&&(A(t,v,!0,"f"),se(t.ctrl.getCtrlUI(),t.playUrlParser,N(t,v,"f")||x.wpd.SupportHEVC||(0,x.isHardSupportHEVC)()))}).catch(function(e){x.logger.error(e)});else{A(this,v,!1,"f");var i=r.getQualityDesc();if((null==i?void 0:i.codec)!==x.CodecType.HEVC)return void se(this.ctrl.getCtrlUI(),r,!1);var n=(0,z.getHEVCDowngradeQn)(i,r.getAVCQnCandidates());this.switchQuality(n)}}},e.prototype.destroy=function(e){var t,r;x.logger.info("live player destroy, holdLastFrame: ".concat(String(e))),null===(t=N(this,i,"f"))||void 0===t||t.destroy(e),N(this,u,"f")||(A(this,u,!0,"f"),N(this,m,"f").call(this,ee.Destroyed),null===(r=this.replay)||void 0===r||r.destroy(),N(this,C,"f").call(this),this.ctrl.destroy(),N(this,g,"f").destroy(),N(this,l,"f").forEach(function(e){return e()}),A(this,l,[],"f"))},e.prototype.switchQuality=function(e,t){var r,i,n=this;void 0===t&&(t=""),x.logger.info("switchQuality to ".concat(e));var o=this.playUrlParser;if(null!=o){var a=o.getCurStreamInfo().host,l=o.getQualityDesc(e),u=o.getCurQuality(),c=o.getQualityDesc(u),d=o.getQualityDesc(null!==(r=N(this,f,"f"))&&void 0!==r?r:"0");if(null!=l&&null!=d&&null!=c){if(0===Number((0,x.getCookie)("DedeUserID"))&&l.code>d.code)return x.logger.warn("user not login, reject switch quality"),N(this,m,"f").call(this,x.ExternalEventType.SwitchQualityNotLogin,{newQn:{qn:e,text:l.label},oldQn:{qn:c.value,text:c.label}}),!1;if((0,x.toast)("".concat(t,"清晰度即将切换至").concat(l.label),this.container),A(this,s,{success:function(){(0,x.toast)("".concat(t,"清晰度已经切换至").concat(l.label),n.container),A(n,s,null,"f"),N(n,m,"f").call(n,x.ExternalEventType.SwitchQuality,e,c.value,o.getQnCandidates().map(function(e){var t=e.label;return{qn:e.value,desc:t}}))}},"f"),c.code===l.code)return null===(i=this.playUrlParser)||void 0===i||i.useStream({codec:l.codec}),void this.reload();N(this,I,"f").call(this,l.code).then(function(){var t,r,i=l.code===x.EQuality.Dolby?x.ProtocolType.HTTP_HLS:void 0;null===(t=n.playUrlParser)||void 0===t||t.useStream({codec:l.codec,protocol:i}),n.reload();var o=null===(r=n.playUrlParser)||void 0===r?void 0:r.getCurStreamInfo().host;R.default.operation(R.default.OperationCode.SwitchQuality,{fromQuality:u,toQuality:e,fromHost:a,toHost:o})}).catch(function(e){x.logger.error(e)})}else x.logger.error("switchQuality: quality parser error. ".concat(JSON.stringify({targetQnDesc:l,curQnDesc:c,defQnDesc:d})))}},e.prototype.switchLine=function(e,t){var r,i,n,o=this;void 0===t&&(t=!0);var a=this.playUrlParser;if(null!=a){var l=a.getCurStreamInfo().host;t&&(0,x.toast)("线路即将切换至".concat(null!==(i=null===(r=a.getLineCandidates().find(function(t){return t.value===e}))||void 0===r?void 0:r.label)&&void 0!==i?i:""),this.container),A(this,s,{success:function(){t&&(0,x.toast)("线路已经切换至".concat(a.getCurLineDesc().label),o.container),A(o,s,null,"f"),N(o,m,"f").call(o,x.ExternalEventType.SwitchLine,e)}},"f"),null===(n=this.playUrlParser)||void 0===n||n.setCurLine(e);var u=a.getCurStreamInfo().host;R.default.operation(R.default.OperationCode.SwitchLine,{line:e,fromHost:l,toHost:u}),this.reload()}},e.prototype.capturePic=function(e,t){var r,n;return null!==(n=null===(r=N(this,i,"f"))||void 0===r?void 0:r.capturePic(e,t))&&void 0!==n?n:null},e}();function ie(e,t,r){var i=this,n=!1,o=e.onRefresh(function(){var e,i;t.once(F.EventType.FirstFrame,function(){n&&((0,x.toast)("刷新成功",t.container),n=!1)}),(0,x.toast)("正在刷新",t.container),n=!0,!0===(null===(e=t.replay)||void 0===e?void 0:e.isReplay)&&(null===(i=t.replay)||void 0===i||i.returnLive()),t.tmShiftHandler(0),t.reload(),r(),R.default.operation(R.default.OperationCode.Refresh)}),a=e.onChange(function(e,r){return U(i,void 0,void 0,function(){return M(this,function(i){return"quality"===e?t.switchQuality(r):"line"===e&&t.switchLine(r),le(e,r),[2]})})});return function(){o(),a()}}function ne(e,t){var r=Date.now()/1e3-e-performance.now()/1e3,i=window.setInterval(function(){t.time={value:(0,x.formatTime)(performance.now()/1e3+r),tips:"直播持续时间"}},1e3);return function(){clearInterval(i)}}function oe(e){var t=[],r=e.getVideoEl(),i=0;return x.logger.info("start monitor buffer length"),e.on(F.EventType.VideoInfo,function(e){var n=e.realtimeInfo;if(!r.paused){var o=n.videoBufferLength;(o>10||i===r.currentTime&&o>5)&&(r.currentTime+=o/2,x.logger.warn("auto discard frame, current time: ".concat(r.currentTime)),t.length<3&&((t=t.filter(function(e){return performance.now()-e<5e3})).push(performance.now()),3===t.length&&R.default.custom(R.default.CustomCode.AutoDiscardFrame,null,{extFields:"all"}))),i=r.currentTime}})}function ae(e,t){if(null===t)return function(){};if(!x.ua.isChrome()&&!x.ua.isEdg())return function(){};var r=t.auto_sync_enable,i=t.auto_sync_high_speed,n=t.auto_sync_low_speed,o=t.auto_sync_max_threshold,a=t.auto_sync_min_threshold;return 1!==r?function(){}:(x.logger.info("live player start auto sync video progress"),e.on(F.EventType.VideoInfo,function(t){var r=1e3*t.realtimeInfo.videoBufferLength;if(!(r<0||isNaN(r))){var l=e.getVideoEl(),s=1;r<a?s=n:r>o&&(s=i),(s<=0||s>2)&&(s=1),s!==l.playbackRate&&(l.playbackRate=s)}}))}function le(e,t){"danmaku"===e?R.default.operation(R.default.OperationCode.Danmaku,k({},t)):"volume"===e?!0===t.disabled?R.default.operation(R.default.OperationCode.Mute):R.default.operation(R.default.OperationCode.Volume,{value:t.value}):"playStatus"===e?!0===t?R.default.operation(R.default.OperationCode.Play):R.default.operation(R.default.OperationCode.Pause):"fullScreenStatus"===e?R.default.operation(R.default.OperationCode.FullScreen,{value:t}):"webFullScreenStatus"===e&&R.default.operation(R.default.OperationCode.WebFullScreen,{value:t})}function se(e,t,r){var i,n,o,a={list:null!==(i=t.getLineCandidates())&&void 0!==i?i:[],value:null!==(n=t.getCurLine())&&void 0!==n?n:0};e.line=a;var l=t.getQnCandidates();r||(l=t.getAVCQnCandidates());var s={list:l,value:null!==(o=t.getCurQuality())&&void 0!==o?o:"0"};e.quality=s}function ue(e,t,r){x.logger.debug("listen sticker SEI");var i=null,n=!1,o=t.on(x.ExternalEventType.SEIParseData,function(e,t){e===x.SEIType.LIVE_SEI_CHANNEL&&(n||(n=!0,i=new J.default(r)),null==i||i.onSei(t))}),a=e.on(F.EventType.MetaData,function(e){n&&(x.logger.info("destroy sticker when metadata"),null==i||i.destroy(),n=!1)}),l=0,s=t.ctrl.onChange(function(e,t){"webFullScreenStatus"!==e&&"fullScreenStatus"!==e||(clearTimeout(l),l=window.setTimeout(function(){null==i||i.calcDisplayInfo(),null==i||i.batchUpdateStickerElement()},"webFullScreenStatus"===e?10:300))}),u=e.on(F.EventType.VideoInfo,function(e){null==i||i.onVideoInfo({width:e.mediaInfo.width,height:e.mediaInfo.height})});t.once(ee.Destroyed,f),e.once(F.EventType.Destroyed,f);var c=!1;function f(){c||(c=!0,x.logger.info("destroy sticker..."),clearTimeout(l),null==i||i.destroy(),s(),o(),a(),u())}}function ce(e,t){var r=t.userId,i=t.ownerId,n=t.isMobile,o=new Q.default(e);return(r===i||n)&&o.setCurP2PType(te[o.getCurP2PType()]),o}exports.LivePlayer=re,t=new WeakMap,r=new WeakMap,i=new WeakMap,n=new WeakMap,o=new WeakMap,a=new WeakMap,l=new WeakMap,s=new WeakMap,u=new WeakMap,c=new WeakMap,f=new WeakMap,d=new WeakMap,p=new WeakMap,h=new WeakMap,y=new WeakMap,v=new WeakMap,g=new WeakMap,m=new WeakMap,E=new WeakMap,P=new WeakMap,S=new WeakMap,w=new WeakMap,T=new WeakMap,C=new WeakMap,I=new WeakMap,_=new WeakMap,b=new WeakMap,L=new WeakMap,V=new WeakMap;var fe=function(e,t,r,i,n){var o=[];if(e.getCurStreamInfo().qualityDesc.some(function(e){var t;return!0===(null===(t=e.attr_desc)||void 0===t?void 0:t.some(function(e){return"panorama"===e.attr_name}))})){var a=(0,Z.showPanoramaTip)(t,r);if(null!=a){n.show();var l=setTimeout(function(){n.hide()},1e4);o.push(a,function(){clearTimeout(l)});var s=n.onChange(function(e,t){"qualityPanelShow"===e&&!0===t&&(a(),s(),clearTimeout(l))})}}if("panorama"===e.getCurStreamInfo().curAttrName){var u=new Z.Panorama(t,i,function(){(0,x.toast)("资源加载失败，无法进行全景交互",t)});o.push(u.destroy)}return o},de=(0,x.throttle)(function(e){R.default.custom(R.default.CustomCode.SEILatency,{sei_latency:e},{extFields:["p2pType","sHost","sProtocol","sCodec","quality","sName"],sampleRate:.01})},6e4),pe=(0,x.debounce)(function(e){return e()},6e4);
})()