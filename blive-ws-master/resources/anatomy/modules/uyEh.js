/**
 * id: uyEh
 * path: @bilibili-live/web-player-danmaku
 */

(function(require,module,exports) {
"use strict";var e,t,n,i,o,a,r,l,s,f,c,u,d,h,m,p=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,a){function r(e){try{s(i.next(e))}catch(t){a(t)}}function l(e){try{s(i.throw(e))}catch(t){a(t)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,l)}s((i=i.apply(e,t||[])).next())})},v=this&&this.__generator||function(e,t){var n,i,o,a,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(l){return function(s){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,l[0]&&(r=0)),r;)try{if(n=1,i&&(o=2&l[0]?i.return:l[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,l[1])).done)return o;switch(i=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return r.label++,{value:l[1],done:!1};case 5:r.label++,i=l[1],l=[0];continue;case 7:l=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===l[0]||2===l[0])){r=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){r.label=l[1];break}if(6===l[0]&&r.label<o[1]){r.label=o[1],o=l;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(l);break}o[2]&&r.ops.pop(),r.trys.pop();continue}l=t.call(e,r)}catch(s){l=[6,s],i=0}finally{n=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}},w=this&&this.__classPrivateFieldSet||function(e,t,n,i,o){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?o.call(e,n):o?o.value=n:t.set(e,n),n},y=this&&this.__classPrivateFieldGet||function(e,t,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(e):i?i.value:t.get(e)},b=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DmType=void 0,require("requestidlecallback-polyfill");var k,g=b(require("@bilibili-live/live-danmaku-engine-v2")),E=b(require("./mask-decoder")),M=require("@bilibili-live/web-player-common"),x=(0,M.isWebPSupported)(),T=150;!function(e){e[e.Text=0]="Text",e[e.Emoji=1]="Emoji",e[e.Voice=2]="Voice"}(k=exports.DmType||(exports.DmType={}));var W="web-player-danmaku",P="danmaku-item-container",_=function(){function b(b,g){var M=this;this.container=b,this.opts=g,e.set(this,void 0),t.set(this,void 0),n.set(this,[]),i.set(this,!1),o.set(this,void 0),a.set(this,void 0),r.set(this,void 0),l.set(this,void 0),s.set(this,null),f.set(this,[]),c.set(this,void 0),u.set(this,void 0),d.set(this,0),h.set(this,function(e){var n=null!=e.dm_v2?{mode:e.mode,dm:e.dm_v2}:void 0;e.dmType===k.Emoji?M.getEmoticonInfo(e).then(function(i){var o=i.html,a=i.emojiRatio;e=Object.assign({},e,{html:o,emojiRatio:a}),y(M,t,"f").add(e,n)}).catch(function(e){console.error(e)}):y(M,t,"f").add(e,n)}),m.set(this,function(){w(M,s,window.requestIdleCallback(function(e){if(null!=e.timeRemaining)for(var t=function(){var e=y(M,n,"f").shift(),t=100*y(M,f,"f").length,i=setTimeout(function(){y(M,h,"f").call(M,e),y(M,f,"f").shift()},t);y(M,f,"f").push(i)};(e.timeRemaining()>0||e.didTimeout)&&y(M,n,"f").length>0&&y(M,f,"f").length<10;)t();if(y(M,n,"f").length>0)return y(M,m,"f").call(M);null!=y(M,s,"f")&&(window.cancelIdleCallback(y(M,s,"f")),w(M,s,null,"f"))},{timeout:1e3}),"f")}),this.parseEmoticon=function(e,t){return p(M,void 0,Promise,function(){var n,i;return v(this,function(o){switch(o.label){case 0:return!1,e.dmType!==k.Emoji?[3,2]:(n=new Image,i=t.url,n.style.width="100%",n.style.height="100%",n.src="".concat(i).concat(x?"@56h.webp":"@56h.png"),[4,new Promise(function(e){n.onerror=function(){e(!0)},n.onload=function(){e(!1)}})]);case 1:return o.sent()?[2,""]:[2,n.outerHTML];case 2:return[2,""];case 3:return[2]}})})},this.getEmoticonInfo=function(e){return p(M,void 0,Promise,function(){var t,n,i,o;return v(this,function(a){switch(a.label){case 0:return t=null!==(o=e.emoticonOptions)&&void 0!==o?o:{width:1,height:1,url:"",emoji:""},[4,this.parseEmoticon(e,t)];case 1:return n=a.sent(),i=e.dmType===k.Emoji?Number((t.width/t.height).toFixed(1)):1,[2,{html:n,emojiRatio:i}]}})})},this.add=function(e,i){if(void 0===i&&(i=!1),null!=y(M,t,"f")){if(i)return y(M,h,"f").call(M,e);y(M,n,"f").length>20&&y(M,n,"f").shift(),y(M,n,"f").push(e),null==y(M,s,"f")&&y(M,m,"f").call(M)}},this.onPlay=function(e){w(M,o,e,"f")},this.onPause=function(e){w(M,a,e,"f")},this.offPlay=function(){w(M,o,void 0,"f")},this.offPause=function(){w(M,a,void 0,"f")},this.onSelect=function(e){M.offSelect(),w(M,r,e,"f"),w(M,l,function(n){var i,o=M.container.getBoundingClientRect(),a=Number(null!==(i=getComputedStyle(document.documentElement).zoom)&&void 0!==i?i:1),r=n.clientX/a-o.left,l=n.clientY/a-o.top,s=y(M,t,"f").searchAreaDanmaku(r,l);s.length>0&&(e(s.map(function(e){return e.textData})),n.preventDefault())},"f"),M.container.addEventListener("contextmenu",y(M,l,"f"),!0)},this.offSelect=function(){var e;null!=y(M,l,"f")&&(null===(e=M.container)||void 0===e||e.removeEventListener("contextmenu",y(M,l,"f"),!0),w(M,l,void 0,"f"))},this.play=function(){var e;y(M,i,"f")||(w(M,i,!0,"f"),null===(e=y(M,t,"f"))||void 0===e||e.play(),null!=y(M,o,"f")&&y(M,o,"f").call(M))},this.pause=function(){var e;y(M,i,"f")&&(w(M,i,!1,"f"),null===(e=y(M,t,"f"))||void 0===e||e.pause(),null!=y(M,a,"f")&&y(M,a,"f").call(M))},this.setRenderType=function(n){var i;null===(i=y(M,t,"f"))||void 0===i||i.setType(n),null!=y(M,e,"f")&&M.setBackGroundImage(y(M,e,"f")),null!=y(M,l,"f")&&(M.offSelect(),null!=y(M,r,"f")&&M.onSelect(y(M,r,"f")))},this.resize=function(){var e;if(null==y(M,t,"f"))return M;var n=y(M,t,"f").config.container;return null!=n&&(n.style.width="".concat(y(M,c,"f").clientWidth,"px"),n.style.height="".concat(y(M,c,"f").clientHeight,"px"),null===(e=y(M,t,"f"))||void 0===e||e.resize()),M},this.show=function(){var e;null===(e=y(M,t,"f"))||void 0===e||e.visible(!0)},this.hide=function(){var e;null===(e=y(M,t,"f"))||void 0===e||e.visible(!1)},this.setBackGroundImage=function(t){if(null==y(M,c,"f"))throw new Error("danmakuWrapNode must be HTMLElement");t!==y(M,e,"f")&&w(M,e,t,"f"),y(M,c,"f").style.backgroundImage="url(".concat(t,")"),y(M,c,"f").style.backgroundRepeat="no-repeat",y(M,c,"f").style.backgroundPosition="center",y(M,c,"f").style.backgroundSize="contain"},this.set=function(e){var n=y(M,t,"f");if(null!=n)for(var i in e){var o=e[i];switch(i){case"type":M.setRenderType(o);break;case"backgroundImage":M.setBackGroundImage(o);break;case"maxCount":i="danmakuNumber",n.option(i,o);break;default:n.option(i,o)}}},this.clear=function(){var e;null===(e=y(M,t,"f"))||void 0===e||e.clear()},this.destroy=function(){var e;y(M,c,"f").remove(),null===(e=y(M,t,"f"))||void 0===e||e.destroy(),w(M,t,null,"f"),y(M,u,"f").destroy(),null!=y(M,s,"f")&&(window.cancelIdleCallback(y(M,s,"f")),w(M,s,null,"f")),w(M,n,[],"f"),y(M,f,"f").forEach(function(e){return window.clearTimeout(e)}),window.removeEventListener("resize",M.resize),cancelAnimationFrame(y(M,d,"f"))},this.addMaskSVG=function(e){y(M,u,"f").input(e[1],e[3])},this.clearMask=function(){y(M,u,"f")._masks=[]},this.addMaskToWrap=function(e){var t=y(M,c,"f"),n=y(M,u,"f");cancelAnimationFrame(y(M,d,"f"));w(M,d,window.requestAnimationFrame(function i(o){o>performance.now()-5&&n.onUpdateMask(e,t),w(M,d,window.requestAnimationFrame(i),"f")}),"f")},this.fullscreenDM=function(){y(M,c,"f").style.position="fixed"},this.offsetDM=function(e){y(M,c,"f").style.transform="translate3d(".concat(e,"px, ").concat(e,"px, 0)")},w(this,e,null==g?void 0:g.backgroundImage,"f"),w(this,c,document.createElement("div"),"f"),y(this,c,"f").classList.add(W),y(this,c,"f").style.cssText="\n        width: 100%;\n        height: 100%;\n        position: relative;\n        top: 0;\n        left: 0;\n        z-index: 8;\n        pointer-events: none;\n      ",b.appendChild(y(this,c,"f")),this.initialize(),w(this,u,new E.default,"f")}return b.prototype.initialize=function(){var n,i,o=document.createElement("div");o.classList.add(P);var a=document.createElement("style");a.innerHTML="\n        .".concat(W," .").concat(P,"{\n          width: ").concat(y(this,c,"f").clientWidth,"px;\n          height: ").concat(y(this,c,"f").clientHeight,"px;\n          position: relative;\n          overflow: hidden;\n        }"),document.getElementsByTagName("HEAD")[0].appendChild(a),y(this,c,"f").appendChild(o),w(this,t,new g.default({container:o,isLive:!0,type:"div",opacity:1,fontSize:1,duration:6,danmakuArea:100,danmakuNumber:T,isRecycling:!0,isMobile:null!==(i=null===(n=this.opts)||void 0===n?void 0:n.isMobile)&&void 0!==i&&i}),"f"),null!=y(this,e,"f")&&this.setBackGroundImage(y(this,e,"f")),window.addEventListener("resize",this.resize)},b.prototype.closeMask=function(e){cancelAnimationFrame(y(this,d,"f")),e||y(this,c,"f").style.removeProperty("-webkit-mask-image")},b.prototype.getDanmakuElement=function(){return y(this,c,"f")},b}();e=new WeakMap,t=new WeakMap,n=new WeakMap,i=new WeakMap,o=new WeakMap,a=new WeakMap,r=new WeakMap,l=new WeakMap,s=new WeakMap,f=new WeakMap,c=new WeakMap,u=new WeakMap,d=new WeakMap,h=new WeakMap,m=new WeakMap,exports.default=_;
})()