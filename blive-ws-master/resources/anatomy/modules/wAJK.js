/**
 * id: wAJK
 * path: ./GoldMiner
 */

(function(require,module,exports) {
"use strict";var e,t,i,s,a,o,n,r,c,d=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))(function(a,o){function n(e){try{c(s.next(e))}catch(t){o(t)}}function r(e){try{c(s.throw(e))}catch(t){o(t)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,r)}c((s=s.apply(e,t||[])).next())})},p=this&&this.__classPrivateFieldGet||function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)},h=this&&this.__classPrivateFieldSet||function(e,t,i,s,a){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?a.call(e,i):a?a.value=i:t.set(e,i),i},l=this&&this.__rest||function(e,t){var i={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(s=Object.getOwnPropertySymbols(e);a<s.length;a++)t.indexOf(s[a])<0&&Object.prototype.propertyIsEnumerable.call(e,s[a])&&(i[s[a]]=e[s[a]])}return i},f=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.multitask=exports.GoldMiner=void 0;const u=f(require("./idb")),m=require("./report"),$=require("./utils"),g=(0,$.getSizeInBytes)({$mainId:(0,$.shortUUID)(),$id:(0,$.UUID)(),$createTime:Date.now(),$expire:-1,$content:"",$type:"xxxx"}),v={expire:432e6,maxSpace:20,dbVersion:1},y={main:"$id",logList:"$id, $mainId"};class T{constructor(d){e.set(this,{}),t.set(this,{main:[],logList:[]}),i.set(this,void 0),s.set(this,"closed"),a.set(this,void 0),o.set(this,void 0),n.set(this,void 0),r.set(this,!1),c.set(this,void 0),Object.assign(p(this,e,"f"),v,d),h(this,i,`GM-${p(this,e,"f").appName}`,"f"),this.idb=new u.default(p(this,i,"f")).version(p(this,e,"f").dbVersion),h(this,a,{$id:(0,$.shortUUID)()},"f"),d.init&&this.init(d.init)}static recieveMsg(e,t){return void 0===T.GoldMinerCahce[t.appName]&&(T.GoldMinerCahce[t.appName]=new T({appName:t.appName,env:t.env})),T.GoldMinerCahce[t.appName].reportManyLog({timeRage:[e.data.start_timestamp,e.data.end_timestamp],sourceType:t.source,msgId:e.data.msg_id,appId:e.data.app_id,appName:e.data.app_name,latestCount:t.latestCount}).catch(console.error)}init(i,s=!0){p(this,a,"f").$createTime?(p(this,t,"f").main=[],p(this,t,"f").logList=[],h(this,a,Object.assign(Object.assign({$id:(0,$.shortUUID)()},i),{$expire:p(this,e,"f").expire,$createTime:Date.now(),$updateTime:Date.now()}),"f")):Object.assign(p(this,a,"f"),Object.assign(Object.assign({},i),{$expire:p(this,e,"f").expire,$createTime:Date.now(),$updateTime:Date.now()})),p(this,a,"f").$space=(0,$.getSizeInBytes)(p(this,a,"f")),p(this,t,"f").main[0]=p(this,a,"f"),s&&this.initStore().then(()=>{this.startQueueTask("main")})}initStore(){return d(this,void 0,void 0,function*(){if("opening"!==p(this,s,"f")&&"opened"!==p(this,s,"f")){h(this,s,"opening","f");try{yield this.idb.stores(y),h(this,o,this.idb.getStore("main"),"f"),h(this,n,this.idb.getStore("logList"),"f"),h(this,s,"opened","f"),this.startQueueTask("logList")}catch(e){console.error(e)}}})}destroy(){this.idb.close(),p(this,s,"f")}startQueueTask(e){if(!Array.isArray(p(this,t,"f")[e])||"opened"!=p(this,s,"f")||void 0===p(this,a,"f"))return;const i=this.idb.getStore(e),n=()=>{var s;if("logList"===e&&p(this,t,"f")[e].length){const s=p(this,t,"f")[e].shift();if(!s)return;p(this,a,"f").$updateTime=s.$createTime,p(this,a,"f").$space=(p(this,a,"f").$space||0)+(0,$.getSizeInBytes)(s.$content)+g,i.add(s).then(()=>{var e;n(),p(this,a,"f").$createTime&&(null===(e=p(this,o,"f"))||void 0===e||e.put(p(this,a,"f")))}).catch(n)}else if("main"===e){if(!p(this,t,"f")[e].shift())return;null===(s=p(this,o,"f"))||void 0===s||s.put(p(this,a,"f")).then(()=>{p(this,r,"f")||(h(this,r,!0,"f"),this.checkSpaceAndClear())})}};n()}log(e){var i;!p(this,o,"f")&&p(this,a,"f").$createTime&&this.initStore();const s=Date.now(),n={$id:(0,$.UUID)(),$mainId:p(this,a,"f").$id,$content:e,$createTime:s,$expire:-1};"object"==typeof e&&(n.$content=e.content,n.$createTime=null!==(i=e.ts)&&void 0!==i?i:s,void 0!==e.type&&(n.$type=e.type)),p(this,t,"f").logList.push(n),p(this,t,"f").logList.length<2&&this.startQueueTask("logList")}checkSpaceAndClear(){return d(this,void 0,void 0,function*(){if(!p(this,n,"f")||!p(this,o,"f"))return;const t=yield p(this,o,"f").getAll();let i=0;const s=[],a={};if(t.forEach(t=>{var o;(void 0===t.$expire||t.$expire>5184e6)&&(t.$expire=p(this,e,"f").expire),void 0===t.$createTime&&(t.$createTime=t.$updateTime),i+=null!==(o=t.$space)&&void 0!==o?o:0,Date.now()-t.$updateTime<6e5&&0!==t.$expire||(Date.now()-(t.$createTime||t.$updateTime)>t.$expire?s.push(t.$id):a[t.$id]=t)}),yield this.removeLogList(s),i/1048576>=p(this,e,"f").maxSpace){const e=Date.now(),t=[];for(const o in a)if(Object.prototype.hasOwnProperty.call(a,o)){const i=a[o];e-i.$createTime>i.$expire/2&&t.push(i.$id)}yield this.removeLogList(t);const i=p(this,n,"f").getStore();if(!i)return;const s=i.openCursor();s.onsuccess=(e=>{const t=s.result;if(t){const e=t.value;return void 0===a[e.$mainId]&&t.delete(),void t.continue()}})}})}removeLogList(e){var t;return d(this,void 0,void 0,function*(){if(p(this,n,"f")&&p(this,o,"f"))for(const i of e)i!==(null===(t=p(this,a,"f"))||void 0===t?void 0:t.$id)&&(p(this,o,"f").delete(i),yield p(this,n,"f").deleteByIndex("$mainId",i))})}recieveMsg(t,i){switch(t.cmd){case"LIVE_PLAYER_LOG_RECYCLE":w(t.data.msg_id,()=>d(this,void 0,void 0,function*(){t.data.user_id===(0,$.getUserId)()&&t.data.app_name===p(this,e,"f").appName&&(yield this.reportManyLog({timeRage:[t.data.start_timestamp,t.data.end_timestamp],sourceType:i.source,msgId:t.data.msg_id,appId:t.data.app_id,appName:t.data.app_name,latestCount:i.latestCount}).catch(console.error))}))}}report(t){let i;return t.startTime&&t.endTime&&(i=[t.startTime,t.endTime]),this.reportManyLog({timeRage:i,sourceType:t.source,appName:p(this,e,"f").appName,latestCount:t.latestCount,msgId:t.msgId})}reportManyLog(t){return d(this,void 0,void 0,function*(){const i=yield this.getLogs({timeRange:t.timeRage,latestCount:t.latestCount||10}),s=[];for(const a of i){const{$id:i,$expire:o,$space:n,$createTime:r,$updateTime:c}=a,d=l(a,["$id","$expire","$space","$createTime","$updateTime"]);(yield(0,m.reportLog)({data:Object.assign({createTime:r,updateTime:c},d),appName:t.appName,sourceType:t.sourceType,msgId:t.msgId,appId:t.appId},p(this,e,"f").env))&&s.push(i)}this.removeLogList(s)})}getLogs({timeRange:e,latestCount:t=40}){var i,s;return d(this,void 0,void 0,function*(){if(!p(this,n,"f")||!p(this,o,"f"))return yield this.initStore(),yield(0,$.sleep)(200),this.getLogs({timeRange:e,latestCount:t});const a=[];let r=(yield p(this,o,"f").getAll()).sort((e,t)=>(t.$createTime||t.$updateTime)-(e.$createTime||t.$updateTime));if(Array.isArray(e)){const t=null!==(i=e[0])&&void 0!==i?i:Date.now()-3e3,a=null!==(s=e[1])&&void 0!==s?s:Date.now();r=r.filter(e=>e.$createTime>=t&&e.$createTime<=a)}t>0&&(r=r.slice(0,t));const d=p(this,c,"f")?e=>p(this,c,"f")(e):function(e){var t;let i,s=e.$createTime;"object"==typeof e.$content&&null!==e.$content&&(i=e.$content.color,s=null!==(t=e.$content.ts)&&void 0!==t?t:s,delete e.$content.color,delete e.$content.ts);const a={content:e.$content,ts:s};return e.$type&&(a.type=e.$type),i&&(a.color=i),a};for(const e of r){const t=yield p(this,n,"f").queryWithIndex("$mainId",e.$id);a.push(Object.assign(Object.assign({},e),{logList:t.map(d)}))}return a})}formatter(e){h(this,c,e,"f")}}function w(e,t){return d(this,void 0,void 0,function*(){yield new Promise(e=>{setTimeout(()=>{e()},300*Math.random()|0)});const i=void 0===e?"":`live-log-report-${e}`;if(""!==i){if(null!==localStorage.getItem(i))return;localStorage.setItem(i,"1")}yield t(),""!==i&&localStorage.removeItem(i)})}exports.GoldMiner=T,e=new WeakMap,t=new WeakMap,i=new WeakMap,s=new WeakMap,a=new WeakMap,o=new WeakMap,n=new WeakMap,r=new WeakMap,c=new WeakMap,T.GoldMinerCahce={},exports.multitask=w;
})()