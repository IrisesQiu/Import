/**
 * id: rPeE
 * path: ./vibrate/vibrate_task
 */

(function(require,module,exports) {
"use strict";var t,e,i,a,r,n,o,s,f,c=this&&this.__classPrivateFieldSet||function(t,e,i,a,r){if("m"===a)throw new TypeError("Private method is not writable");if("a"===a&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?r.call(t,i):r?r.value=i:e.set(t,i),i},h=this&&this.__classPrivateFieldGet||function(t,e,i,a){if("a"===i&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?a:"a"===i?a.call(t):a?a.value:e.get(t)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.VibrateTask=void 0;var p=require("@bilibili-live/web-player-common"),u=require("./haptic"),l=!0,m=function(){function m(m,d){var b=this;this.dmBiz=d,t.set(this,[]),e.set(this,new u.WebHaptic),i.set(this,void 0),a.set(this,0),r.set(this,null),n.set(this,-1),o.set(this,{shiftLimit:2,curLocation:0,speed:.4,direction:"top"}),this.clear=function(){h(b,t,"f").splice(0,h(b,t,"f").length)},this.input=function(t,e){var i=(0,p.uint8ArrayToString)(e),a=JSON.parse(i);b.addVibrateData({timestamp:t,vibrate:a})},this.output=function(e){if(0!==h(b,t,"f").length){for(var i=0,a=e-h(b,t,"f")[0].timestamp,r=Math.abs(a),n=1;n<h(b,t,"f").length;++n){var o=Math.abs(e-h(b,t,"f")[n].timestamp),s=Math.abs(o);if(!(s<=r))break;i=n,a=o,r=s}var f=h(b,t,"f")[i];return h(b,t,"f").splice(0,i),f}},this.addVibrateData=function(e){if(0===h(b,t,"f").length)h(b,t,"f").push(e);else{for(var i=h(b,t,"f").length-1;i>=0;--i){if(h(b,t,"f")[i].timestamp<e.timestamp){i+=1;break}}h(b,t,"f").splice(i,0,e)}},this.onUpdateVibrate=function(){var t=h(b,i,"f").currentTime,e=b.output(t);if(null!=h(b,a,"f")&&t-h(b,a,"f")>1&&l&&b.webXInputSetState(0,0),null!=e&&null!=e.vibrate&&e.vibrate!==h(b,r,"f")){var n=e.timestamp-t;if(Math.abs(n)<=1){if(l){var o=Math.max(0,n);setTimeout(function(){b.webXInputSetState(e.vibrate.l,e.vibrate.r)},1e3*o)}c(b,r,e.vibrate,"f"),c(b,a,e.timestamp,"f")}}},this.onFrameCallback=function(t){t>performance.now()-5&&b.onUpdateVibrate(),c(b,n,window.requestAnimationFrame(b.onFrameCallback),"f")},this.destroy=function(){cancelAnimationFrame(h(b,n,"f")),c(b,t,[],"f"),b.webXInputSetState(0,0),h(b,e,"f").dispose()},s.set(this,function(t){0===t?(h(b,o,"f").shiftLimit=0,h(b,o,"f").curLocation=0):t<.075?h(b,o,"f").shiftLimit=2:t<=.88?h(b,o,"f").shiftLimit=5:t>.88&&(h(b,o,"f").shiftLimit=7),h(b,o,"f").speed=4*t,h(b,f,"f").call(b)}),f.set(this,function(){"top"===h(b,o,"f").direction?(h(b,o,"f").curLocation+=h(b,o,"f").speed,h(b,o,"f").curLocation+=h(b,o,"f").speed):(h(b,o,"f").curLocation-=h(b,o,"f").speed,h(b,o,"f").curLocation-=h(b,o,"f").speed),Math.abs(h(b,o,"f").curLocation)>h(b,o,"f").shiftLimit&&("top"===h(b,o,"f").direction?(h(b,o,"f").direction="bottom",h(b,o,"f").curLocation=h(b,o,"f").shiftLimit):(h(b,o,"f").direction="top",h(b,o,"f").curLocation=h(b,o,"f").shiftLimit)),null!=b.dmBiz&&b.dmBiz.offsetDM(h(b,o,"f").curLocation)}),c(this,t,[],"f"),c(this,i,m,"f"),this.onFrameCallback(0)}return m.prototype.webXInputSetState=function(t,i){h(this,e,"f").setState(t,i),h(this,s,"f").call(this,h(this,e,"f").getMotorPercent())},m}();exports.VibrateTask=m,t=new WeakMap,e=new WeakMap,i=new WeakMap,a=new WeakMap,r=new WeakMap,n=new WeakMap,o=new WeakMap,s=new WeakMap,f=new WeakMap;
})()