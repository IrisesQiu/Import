/**
 * id: n8Xe
 * path: ./idb
 */

(function(require,module,exports) {
"use strict";var e,t,r,n,o,i,s,c,u,a,d=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function s(e){try{u(n.next(e))}catch(t){i(t)}}function c(e){try{u(n.throw(e))}catch(t){i(t)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,c)}u((n=n.apply(e,t||[])).next())})},h=this&&this.__classPrivateFieldSet||function(e,t,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(e,r):o?o.value=r:t.set(e,r),r},f=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DBCore=void 0;const l=null!==(r=null!==(t=null!==(e=window.indexedDB)&&void 0!==e?e:window.mozIndexedDB)&&void 0!==t?t:window.webkitIndexedDB)&&void 0!==r?r:window.msIndexedDB;function v(e){return console.error(e),!1}function p(e){return"[object Object]"===Object.prototype.toString.call(e)}function w(e,t){for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)){if(t[r]!==e[r])return!1}return!0}function g(e){const t=null!=e?e:"++id",[r,...n]=t.split(",").map(e=>e.trim()),o=r.includes("++");return{keyPath:r.replace("++",""),autoIncrement:o,indexKeys:n}}function m(e){return new Promise((t,r)=>{const n=()=>{e.removeEventListener("success",o),e.removeEventListener("error",i)},o=()=>{t(e.result),n()},i=()=>{r(e.error),v(e.error),n()};e.addEventListener("success",o),e.addEventListener("error",i)})}function y(){return d(this,void 0,void 0,function*(){const e=l.databases;if(!(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent))||void 0===e)return;let t;return yield new Promise(r=>{const n=()=>{e().then(r).catch(r)};t=window.setInterval(n,100),n()}).finally(()=>clearInterval(t))})}function P(e,t,r={}){return new Promise((n,o)=>{y().then(()=>{if(void 0===l)return void o("not support indexedDB");const i=l.open(e,t);i.onupgradeneeded=(e=>{const t=i.result;"function"==typeof r.upgrade&&r.upgrade(t)}),i.onsuccess=(e=>{const t=i.result;n(t)}),i.onerror=(e=>{v(i.error),o(i.error)}),i.onblocked=(e=>{var t,s;if(e instanceof IDBVersionChangeEvent){const o=e,c=e=>{const t=i.result;"function"==typeof r.upgrade&&r.upgrade(t),a()},u=()=>{const e=i.result;n(e),a()},a=()=>{var e,t;null===(e=o.target)||void 0===e||e.removeEventListener("upgradeneeded",c),null===(t=o.target)||void 0===t||t.removeEventListener("success",u)};return null===(t=o.target)||void 0===t||t.addEventListener("upgradeneeded",c),void(null===(s=o.target)||void 0===s||s.addEventListener("success",u))}o(i.error)})}).catch(o)})}function b(e){return m(l.deleteDatabase(e))}function S(e,t){const r={};if(!p(t))return r;for(const n in t)if(!e.objectStoreNames.contains(n)){const{keyPath:o,autoIncrement:i,indexKeys:s}=g(t[n]),c=e.createObjectStore(n,{keyPath:o,autoIncrement:i});s.forEach(e=>{c.createIndex(e,e,{unique:!1})}),r[n]=c}return r}class j{constructor(e){n.set(this,void 0),o.set(this,{}),i.set(this,{}),s.set(this,void 0),c.set(this,void 0),u.set(this,{status:"close"}),this.storeNames=[],h(this,s,e,"f")}getDatabase(){return d(this,void 0,void 0,function*(){return void 0!==f(this,n,"f")?f(this,n,"f"):yield P(f(this,s,"f"))})}version(e){if(isNaN(e)||e<.1)throw Error("Given version is not a positive number");return h(this,c,e,"f"),this}getVersion(){return d(this,void 0,void 0,function*(){if("number"==typeof f(this,c,"f"))return f(this,c,"f");return(yield this.getDatabase()).version})}stores(e){return d(this,void 0,void 0,function*(){if(void 0===f(this,c,"f"))throw Error("Please use version() brefore stores()");const t=`${f(this,s,"f")}-${f(this,c,"f")}`;this.storeNames=Object.keys(e),void 0===f(this,o,"f")[t]&&(f(this,o,"f")[t]=e),void 0!==f(this,n,"f")&&(f(this,u,"f").status="closeing",f(this,n,"f").close());try{h(this,n,yield P(f(this,s,"f"),f(this,c,"f"),{upgrade:t=>{S(t,e),f(this,u,"f").status="opened"}}),"f"),f(this,u,"f").status="opened"}catch(r){throw Error(r)}return this})}getStoreOption(){var e;const t=`${f(this,s,"f")}-${null!==(e=f(this,c,"f"))&&void 0!==e?e:""}`;return f(this,o,"f")[`${t}`]}getStore(e){var t;if(void 0===f(this,o,"f")[`${f(this,s,"f")}-${null!==(t=f(this,c,"f"))&&void 0!==t?t:""}`])throw Error("Please use stores() brefore getStore()");if(void 0===f(this,n,"f"))throw Error("DB is not ready, Please await stores()");return void 0!==f(this,i,"f")[e]?f(this,i,"f")[e]:(f(this,i,"f")[e]=new E(f(this,n,"f"),e),f(this,i,"f")[e])}getStoreNames(){return d(this,void 0,void 0,function*(){const e=yield this.getDatabase();return Array.from(e.objectStoreNames)})}close(){var e;null===(e=f(this,n,"f"))||void 0===e||e.close()}}exports.default=j,n=new WeakMap,o=new WeakMap,i=new WeakMap,s=new WeakMap,c=new WeakMap,u=new WeakMap,j.delete=b;class E{constructor(e,t){a.set(this,10),this.db=e,this.storeName=t}transaction(e){return this.db.transaction(e,"readwrite")}cacheTransaction(e){this.trans=e}getStore(e){if(f(this,a,"f")<=0){v(Error("getStore error"))}else try{return(e||this.transaction([this.storeName])).objectStore(this.storeName)}catch(t){return"function"==typeof t.toString&&t.toString().indexOf("closing")>-1?h(this,a,0,"f"):h(this,a,f(this,a,"f")-1,"f"),void v(t)}}clear(){return d(this,void 0,void 0,function*(){const e=this.getStore();return e?m(e.clear()):Promise.reject(e)})}add(e){return d(this,void 0,void 0,function*(){const t=this.trans?this.getStore(this.trans):this.getStore();return t?m(t.add(e)):Promise.reject(t)})}put(e){return d(this,void 0,void 0,function*(){const t=this.trans?this.getStore(this.trans):this.getStore();return t?m(t.put(e)):Promise.reject(t)})}delete(e){return d(this,void 0,void 0,function*(){const t=this.getStore();return t?m(t.delete(e)):Promise.reject(t)})}deleteMany(e){const t=this.getStore();return t?new Promise((r,n)=>{const o=[],i=function(){const s=e.shift();if(!s)return void(0===o.length?r():n(o));const c=t.delete(s);c.onsuccess=function(){i()},c.onerror=function(){v(c.error),o.push(c.error)}};i()}):Promise.reject(t)}deleteByIndex(e,t){return d(this,void 0,void 0,function*(){const r=this.getStore();return r?new Promise((n,o)=>{const i=r.index(e).openCursor(t),s=[];i.onsuccess=function(){const e=i.result;null!==e?(e.delete(),e.continue()):0===s.length?n():o(s)},i.onerror=function(){v(i.error),s.push(i.error)}}):Promise.reject(r)})}count(e){return d(this,void 0,void 0,function*(){const t=this.getStore();return t?m(t.count(e)):Promise.reject(t)})}get(e){return d(this,void 0,void 0,function*(){const t=this.getStore();return t?m(t.get(e)):Promise.reject(t)})}getAll(){return d(this,void 0,void 0,function*(){const e=this.getStore();return e?m(e.getAll()):Promise.reject(e)})}queryWithIndex(e,t){return d(this,void 0,void 0,function*(){const r=this.getStore();return r?new Promise((n,o)=>{const i=[],s=r.index(e).openCursor(t);s.onsuccess=(e=>{const t=s.result;null!==t?(i.push(t.value),t.continue()):n(i)}),s.onerror=(()=>{v(s.error),o(s.error)})}):Promise.reject(r)})}each(e,t){return d(this,void 0,void 0,function*(){const r=this.getStore();return r?new Promise((n,o)=>{let i=0;const s=r.openCursor(e);s.onsuccess=(e=>{const r=s.result;null!==r?(t(r.value,i++),r.continue()):n()}),s.onerror=(()=>{v(s.error),o(s.error)})}):Promise.reject(r)})}query(e){return d(this,void 0,void 0,function*(){const t=[];return this.each(null,r=>{w(r,e)&&t.push(r)}).then(()=>t)})}}exports.DBCore=E,a=new WeakMap;
})()